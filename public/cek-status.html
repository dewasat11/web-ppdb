<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cek Status Pendaftaran - PPDSB Pondok Pesantren Al Ikhsan Beji</title>

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Optional: Tailwind config tweak
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                50: '#ecfdf5',
                100: '#d1fae5',
                200: '#a7f3d0',
                300: '#6ee7b7',
                400: '#34d399',
                500: '#10b981', // emerald
                600: '#059669',
                700: '#047857',
                800: '#065f46',
                900: '#064e3b',
              }
            }
          }
        }
      }
    </script>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />

    <!-- Toastify (for toastr shim) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />

    <style>
      :root {
        --tw-font-sans: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
      }
      html, body { font-family: var(--tw-font-sans); }
      [x-cloak] { display: none !important; }

      /* Responsive typography */
      @media (max-width: 640px) {
        h1 { font-size: 1.875rem !important; line-height: 2.25rem !important; }
        h2 { font-size: 1.5rem !important; line-height: 2rem !important; }
        h3 { font-size: 1.25rem !important; line-height: 1.75rem !important; }
        .text-lg { font-size: 1rem !important; line-height: 1.5rem !important; }
        .text-xl { font-size: 1.125rem !important; line-height: 1.75rem !important; }
      }
    </style>
  </head>
  <body class="min-h-screen flex flex-col bg-gray-100 text-gray-800">
    <!-- HEADER -->
    <nav class="bg-white shadow-lg sticky top-0 z-50" x-data="{ mobileMenuOpen: false, profileDropdownOpen: false }">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <!-- Logo -->
          <div class="flex-shrink-0 flex items-center">
            <a href="/" class="flex items-center">
              <!-- TODO: ganti src logo -->
              <img src="/assets/img/logo-alikhsan.png" class="h-16 w-auto" />
            </a>
          </div>

          <!-- Desktop Navigation -->
          <div class="hidden md:block">
            <div class="flex items-baseline space-x-4">
              <a href="/" class="text-gray-600 hover:text-brand-600 px-3 py-2 rounded-md text-sm font-medium">Beranda</a>

              <!-- Dropdown Informasi -->
              <div class="relative">
                <button @click="profileDropdownOpen=!profileDropdownOpen" class="text-gray-600 hover:text-brand-600 px-3 py-2 rounded-md text-sm font-medium flex items-center">
                  Informasi
                  <i class="bi bi-caret-down-fill ml-1 text-xs" :class="{'rotate-180': profileDropdownOpen}"></i>
                </button>
                <div x-cloak x-show="profileDropdownOpen" @click.outside="profileDropdownOpen=false" x-transition class="absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg py-2 z-50 border border-gray-100">
                  <a href="/alur-pendaftaran.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Alur Pendaftaran</a>
                  <a href="/syarat-pendaftaran.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Syarat Pendaftaran</a>
                  <a href="/biaya.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Biaya</a>
                </div>
              </div>

              <a href="/brosur.html" class="text-gray-600 hover:text-brand-600 px-3 py-2 rounded-md text-sm font-medium">Brosur</a>
              <a href="/kontak.html" class="text-gray-600 hover:text-brand-600 px-3 py-2 rounded-md text-sm font-medium">Kontak</a>
            </div>
          </div>

          <!-- CTA Button Desktop -->
          <div class="hidden md:block">
            <a href="/login" class="bg-brand-700 hover:bg-brand-800 text-white px-6 py-2 rounded-lg text-sm font-medium shadow-md hover:shadow-lg">Admin</a>
          </div>

          <!-- Mobile menu button -->
          <div class="md:hidden">
            <button @click="mobileMenuOpen=!mobileMenuOpen" class="inline-flex items-center justify-center p-2 rounded-md text-gray-600 hover:text-brand-600 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-brand-500">
              <i class="bi" :class="mobileMenuOpen ? 'bi-x-lg' : 'bi-list'"></i>
        </button>
          </div>
        </div>
      </div>

      <!-- Mobile Backdrop -->
      <div x-cloak x-show="mobileMenuOpen" @click="mobileMenuOpen=false" class="md:hidden fixed inset-0 z-40 bg-black/50"></div>

      <!-- Mobile Menu -->
      <div x-cloak x-show="mobileMenuOpen" x-transition class="md:hidden fixed inset-y-0 left-0 z-50 mobile-menu bg-white shadow-xl border-r border-gray-200 overflow-y-auto">
        <div class="flex items-center justify-between p-4 border-b border-gray-200">
          <div class="flex items-center">
            <img src="/assets/img/logo-alikhsan.png" class="h-16 w-auto" />
          </div>
          <button @click="mobileMenuOpen=false" class="p-2 rounded-md text-gray-500 hover:text-gray-700 hover:bg-gray-100"><i class="bi bi-x-lg"></i></button>
        </div>

        <div class="px-2 pt-4 pb-3 space-y-1">
          <a href="/" class="bg-brand-100 text-brand-700 block px-3 py-2 rounded-md text-base font-medium">Beranda</a>

          <details class="px-1">
            <summary class="cursor-pointer text-gray-700 hover:text-brand-700 hover:bg-gray-50 px-3 py-2 rounded-md text-base font-medium">Informasi</summary>
            <div class="pl-6 space-y-1 mt-2">
              <a href="/alur-pendaftaran.html" class="block px-3 py-2 text-sm rounded-md hover:bg-gray-50">Alur Pendaftaran</a>
              <a href="/syarat-pendaftaran.html" class="block px-3 py-2 text-sm rounded-md hover:bg-gray-50">Syarat Pendaftaran</a>
              <a href="/biaya.html" class="block px-3 py-2 text-sm rounded-md hover:bg-gray-50">Biaya</a>
            </div>
          </details>

          <a href="/brosur.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-gray-50">Brosur</a>
          <a href="/kontak.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-gray-50">Kontak</a>

          <div class="pt-4 pb-2 px-2">
            <a href="/login.html" class="w-full bg-brand-700 hover:bg-brand-800 text-white px-4 py-3 rounded-lg text-base font-medium shadow-md hover:shadow-lg block text-center">Admin</a>
          </div>
        </div>
      </div>
    </nav>

    <!-- Hero Section -->
    <section class="relative bg-gradient-to-br from-brand-800 to-brand-900 min-h-[30vh] flex items-center overflow-hidden">
      <!-- Background Pattern / Banner -->
      <div class="absolute inset-0 opacity-10 z-10">
        <div class="absolute inset-0 bg-gradient-to-br from-blue-600 to-blue-800"></div>
      </div>

      <!-- Content -->
      <div class="relative z-20 container mx-auto px-4">
        <div class="flex justify-center">
          <div class="w-full lg:w-5/6 text-center">
            <h1 class="text-4xl lg:text-5xl font-bold text-white mb-4 leading-tight">
          <i class="bi bi-search"></i> Cek Status Pendaftaran Santri
        </h1>
            <p class="text-lg lg:text-xl text-gray-200 mb-4">
          Masukkan NISN Anda untuk melihat status pendaftaran Pondok Pesantren Al Ikhsan Beji
        </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Main Content -->
    <main class="flex-1 container mx-auto px-4 py-8">
      <div class="max-w-xl mx-auto">
          <!-- Form Cek Status -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-100">
          <div class="p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center gap-2">
              <i class="bi bi-card-text text-brand-600"></i>
              Cek Status Anda
            </h2>

            <form id="cekStatusForm" class="space-y-4">
              <div>
                <label for="nisnInput" class="block text-sm font-medium text-gray-700 mb-1">NISN (Nomor Induk Siswa Nasional)</label>
                  <input
                    type="text"
                    id="nisnInput"
                    placeholder="Masukkan NISN (10 digit)"
                    required
                    pattern="^\d{10}$"
                    title="NISN harus 10 digit angka"
                    maxlength="10"
                  class="block w-full rounded-lg border border-gray-300 focus:border-brand-500 focus:ring-brand-500 px-4 py-3 text-gray-900 placeholder-gray-400"
                  />
                <p class="mt-2 text-sm text-gray-500">
                    Masukkan NISN Anda yang terdiri dari <strong>10 digit angka</strong> (contoh: <code>1234567890</code>).
                </p>
                </div>

              <button type="button" id="btnCekStatus" class="w-full inline-flex items-center justify-center gap-2 bg-brand-600 hover:bg-brand-700 text-white font-semibold px-6 py-3 rounded-lg shadow focus:outline-none focus:ring-2 focus:ring-brand-500 focus:ring-offset-2">
                <i class="bi bi-search"></i>
                Cek Status
                </button>
              </form>
          </div>
        </div>
      </div>
    </main>

    <!-- Modal: Hasil Cek Status -->
    <div x-show="$store.cek.open" x-transition class="fixed inset-0 z-50 flex items-center justify-center" style="display: none;">
      <div class="absolute inset-0 bg-black/50" @click="$store.cek.open=false"></div>
      <div class="relative bg-white rounded-2xl shadow-2xl max-w-3xl w-[92vw] max-h-[85vh] overflow-y-auto">
        <div class="px-6 py-4 bg-gradient-to-br from-brand-700 to-brand-800 text-white rounded-t-2xl flex items-center justify-between">
          <h5 class="font-semibold"><i class="bi bi-clipboard-check"></i> Hasil Cek Status Pendaftaran</h5>
          <button class="text-white/90 hover:text-white" @click="$store.cek.open=false"><i class="bi bi-x-lg"></i></button>
        </div>
        <div class="p-6">
          <!-- Loading state -->
          <div id="statusLoading" class="text-center py-6">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-brand-500 border-t-transparent"></div>
            <p class="mt-4 text-gray-600 font-semibold">Mengambil data status Anda...</p>
          </div>

          <!-- Hasil sukses -->
          <div id="statusResult" class="hidden">
            <div class="text-center mb-4">
              <i id="statusIcon" class="bi bi-hourglass-split text-yellow-500" style="font-size: 3rem;"></i>
            </div>
            <div class="flex justify-center mb-4">
              <span id="statusBadge" class="px-4 py-2 rounded-full bg-gray-500 text-white">-</span>
              </div>
            <div class="bg-white rounded-xl border border-gray-200 shadow-sm mb-3">
              <div class="px-4 py-3 border-b border-gray-100 font-semibold"><i class="bi bi-person-badge"></i> Informasi Pendaftar</div>
              <div class="divide-y divide-gray-100">
                <div class="px-4 py-3 flex justify-between text-sm"><span class="text-gray-500">NISN</span><strong id="f_nisn">-</strong></div>
                <div class="px-4 py-3 flex justify-between text-sm"><span class="text-gray-500">Nama Lengkap</span><strong id="f_nama">-</strong></div>
                <div class="px-4 py-3 flex justify-between text-sm"><span class="text-gray-500">Tanggal Lahir</span><span id="f_tanggal_lahir">-</span></div>
                <div class="px-4 py-3 flex justify-between text-sm"><span class="text-gray-500">Tanggal Daftar</span><span id="f_tanggal_daftar">-</span></div>
              </div>
                </div>
            <div class="bg-white rounded-xl border border-gray-200 shadow-sm" id="statusCatatanSection">
              <div class="px-4 py-3 border-b border-gray-100 font-semibold"><i class="bi bi-clipboard-data"></i> Status & Catatan</div>
              <div class="px-4 py-3 space-y-3">
                <div>
                  <span class="text-gray-500 block mb-1 text-sm">Status Verifikasi</span>
                  <span id="f_status_text" class="inline-block px-3 py-1 rounded bg-gray-500 text-white text-sm">-</span>
                </div>
                <div id="catatanContainer">
                  <span class="text-gray-500 block mb-1 text-sm">Catatan Admin</span>
                  <p id="f_catatan" class="mb-0 text-gray-800">-</p>
                </div>
              </div>
            </div>
            <div id="paymentStatusSection" class="mt-3"></div>
            </div>

            <!-- Error -->
          <div id="statusError" class="hidden rounded-lg bg-yellow-50 border border-yellow-200 text-yellow-900 px-4 py-3" role="alert">
            <div class="flex items-start gap-2">
              <i class="bi bi-exclamation-triangle"></i>
              <div>
              <strong>Perhatian!</strong>
                <p class="mb-0 mt-1" id="statusErrorMsg">Terjadi kesalahan.</p>
              </div>
            </div>
          </div>
        </div>
        <div class="px-6 py-4 border-t border-gray-100 rounded-b-2xl flex justify-end">
          <button type="button" class="inline-flex items-center gap-2 bg-gray-200 hover:bg-gray-300 text-gray-800 px-5 py-3 rounded-lg" @click="$store.cek.open=false">
              <i class="bi bi-x-circle"></i> Tutup
            </button>
        </div>
      </div>
    </div>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <script>
      document.addEventListener('alpine:init', () => {
        Alpine.store('cek', { 
          open: false,
          get isOpen() { 
            console.log('[ALPINE_STORE] cek.open =', this.open); 
            return this.open; 
          }
        });
        console.log('[ALPINE] Store initialized:', Alpine.store('cek'));
      });
      document.addEventListener('DOMContentLoaded', () => {
        // Toastify shim for toastr compatibility
        (function(){
          const s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/toastify-js';
          s.onload = function(){
            window.toastr = {
              success(msg){ Toastify({ text: msg, duration: 4000, close: true, gravity: 'top', position: 'right', style: { background: '#10b981', color: '#fff' }}).showToast(); },
              error(msg){ Toastify({ text: msg, duration: 4000, close: true, gravity: 'top', position: 'right', style: { background: '#ef4444', color: '#fff' }}).showToast(); },
              warning(msg){ Toastify({ text: msg, duration: 4000, close: true, gravity: 'top', position: 'right', style: { background: '#f59e0b', color: '#fff' }}).showToast(); },
              info(msg){ Toastify({ text: msg, duration: 4000, close: true, gravity: 'top', position: 'right', style: { background: '#3b82f6', color: '#fff' }}).showToast(); }
            };
          };
          document.head.appendChild(s);
        })();

        const btn = document.getElementById('btnCekStatus');
        const input = document.getElementById('nisnInput');

        // Safe toast helper with alert fallback
        function toast(type, msg){
          try {
            if (window.toastr && typeof window.toastr[type] === 'function') return window.toastr[type](msg);
          } catch {}
          alert(msg);
        }

        // Enter key triggers
        input?.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') { e.preventDefault(); btn?.click(); }
        });

        btn?.addEventListener('click', async () => {
          const v = input.value?.trim();
          console.log('[CEK_STATUS] Button clicked with NISN:', v);
          
          if (!/^\d{10}$/.test(v)) { 
            console.warn('[CEK_STATUS] Invalid NISN format');
            toast('error', 'NISN harus 10 digit angka'); 
            return; 
          }
          
          // Button loading state
          const originalHTML = btn.innerHTML;
          btn.disabled = true;
          btn.innerHTML = '<span class="inline-block animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></span>Memeriksa...';

          try {
            const cacheBuster = new Date().getTime();
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 12000);
            const apiUrl = `/api/pendaftar_cek_status?nisn=${encodeURIComponent(v)}&_t=${cacheBuster}`;
            console.log('[CEK_STATUS] Fetching:', apiUrl);
            
            const res = await fetch(apiUrl, { signal: controller.signal });
            clearTimeout(timeout);
            console.log('[CEK_STATUS] Response status:', res.status);
            
            const json = await res.json();
            console.log('[CEK_STATUS] Response data:', json);
            
            if (!res.ok || !json?.ok) throw new Error(json?.error || `HTTP ${res.status}`);

            // If not found
            if (!json.data) {
              console.warn('[CEK_STATUS] Data not found for NISN:', v);
              document.getElementById('statusLoading').classList.add('hidden');
              try { toast('warning', 'NISN tidak ditemukan.'); } catch {}
              return;
            }
            
            console.log('[CEK_STATUS] Data found, processing...');

            // Map data
            const data = json.data || {};
            document.getElementById('f_nisn').textContent = data.nisn || v;
            document.getElementById('f_nama').textContent = data.nama || data.namalengkap || '-';
            document.getElementById('f_tanggal_lahir').textContent = (data.tanggal_lahir || data.tanggalLahir || data.tanggallahir || '-')
            document.getElementById('f_tanggal_daftar').textContent = (data.tanggal_daftar || data.created_at || data.createdat || '-')

            // Status badge/icon mapping
            const status = (data.status || data.statusberkas || '').toUpperCase();
            const iconEl = document.getElementById('statusIcon');
            const badgeEl = document.getElementById('statusBadge');
            const statusTextEl = document.getElementById('f_status_text');

            let color = 'gray';
            let label = 'Menunggu';
            if (status === 'TERVERIFIKASI' || status === 'VERIFIED') { color = 'green'; label = 'Terverifikasi'; }
            else if (status === 'DIPROSES' || status === 'PROCESSING') { color = 'blue'; label = 'Diproses'; }
            else if (status === 'DITOLAK' || status === 'REJECTED') { color = 'red'; label = 'Ditolak'; }

            iconEl.className = `bi ${color==='green'?'bi-check-circle-fill':color==='red'?'bi-x-circle-fill':'bi-hourglass-split'} text-${color}-500`;
            badgeEl.className = `px-4 py-2 rounded-full bg-${color}-500 text-white`;
            badgeEl.textContent = label;
            statusTextEl.className = `inline-block px-3 py-1 rounded bg-${color}-500 text-white text-sm`;
            statusTextEl.textContent = label;

            // Catatan
            document.getElementById('f_catatan').textContent = (data.catatan || data.alasan || '-')

            // Payment section (optional)
            const pay = data.payment || {};
            const paySection = document.getElementById('paymentStatusSection');
            if (pay && (pay.status || pay.url)) {
              const payLabel = (pay.status || '').toUpperCase() === 'VERIFIED' ? 'Pembayaran Terverifikasi' : 'Status Pembayaran';
              const payColor = (pay.status || '').toUpperCase() === 'VERIFIED' ? 'green' : 'yellow';
              paySection.innerHTML = `
                <div class="mt-3 rounded-lg border border-${payColor}-200 bg-${payColor}-50 p-4">
                  <div class="font-semibold text-${payColor}-800 mb-1">${payLabel}</div>
                  <div class="text-sm text-${payColor}-700">${pay.note || '-'}</div>
                  ${pay.url ? `<a href="${pay.url}" target="_blank" class="inline-block mt-2 text-${payColor}-800 underline">Lihat Bukti</a>` : ''}
                </div>
              `;
            } else {
              paySection.innerHTML = '';
            }

            // Prepare modal sections for success
            document.getElementById('statusError').classList.add('hidden');
            document.getElementById('statusLoading').classList.add('hidden');
            document.getElementById('statusResult').classList.remove('hidden');
            
            // Open modal only on success
            console.log('[CEK_STATUS] Opening modal with data:', data);
            if (window.Alpine && Alpine.store && Alpine.store('cek')) {
              Alpine.store('cek').open = true;
              console.log('[CEK_STATUS] Modal store set to true');
              
              // Force check DOM visibility
              setTimeout(() => {
                const modalEl = document.querySelector('[x-show="\\$store.cek.open"]');
                console.log('[CEK_STATUS] Modal element:', modalEl);
                console.log('[CEK_STATUS] Modal display style:', modalEl?.style.display);
                console.log('[CEK_STATUS] Modal computed display:', window.getComputedStyle(modalEl).display);
                console.log('[CEK_STATUS] Store value after set:', Alpine.store('cek').open);
              }, 100);
            } else {
              console.error('[CEK_STATUS] Alpine store not ready!');
              alert('Modal tidak dapat dibuka. Silakan refresh halaman.');
            }
          } catch (e) {
            console.error('[CEK_STATUS] Error:', e);
            // Show error toast, do not open modal
            try { toast('error', e?.message || 'Terjadi kesalahan.'); } catch {}
          } finally {
            btn.disabled = false;
            btn.innerHTML = originalHTML;
          }
        });
      });
    </script>
    <!-- FOOTER -->
    <footer class="bg-white text-gray-600 py-6 shadow-2xl border-t border-gray-200 mt-auto">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <p class="text-sm">&copy; 2025 Pondok Pesantren Al Ikhsan Beji. All rights reserved. <span class="hidden sm:inline">Development by Tim IT Pesantren</span></p>
      </div>
    </footer>
  </body>
</html>
