<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="csrf-token" content="{{CSRF_TOKEN}}" />
    <meta name="description" content="Formulir pendaftaran santri baru Pondok Pesantren Al Ikhsan Beji. Isi data diri, pendidikan, orang tua, dan unggah berkas pendaftaran." />
    <meta name="keywords" content="Formulir Pendaftaran, PPDSB, Pondok Pesantren Al Ikhsan Beji, Pendaftaran Santri Baru, Beji, Depok" />

    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="icon" type="image/png" href="/favicon.png" sizes="32x32">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">

    <title>Formulir Pendaftaran - PPDSB Pondok Pesantren Al Ikhsan Beji</title>

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Optional: Tailwind config tweak
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                50: '#ecfdf5',
                100: '#d1fae5',
                200: '#a7f3d0',
                300: '#6ee7b7',
                400: '#34d399',
                500: '#10b981', // emerald
                600: '#059669',
                700: '#047857',
                800: '#065f46',
                900: '#064e3b',
              }
            }
          }
        }
      }
    </script>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />

    <!-- Choices.js / Flatpickr / Toastify (opsional, kompatibel dgn snippet lama) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
      document.addEventListener('alpine:init', () => {
        Alpine.store('modals', { showKonfirmasi: false, showSukses: false });
        console.log('[ALPINE] Store initialized:', Alpine.store('modals'));
      });
    </script>
    <style>
      [x-cloak] { display: none !important; }
      /* Force hide modals initially, then show via JS */
      .modal-hidden { display: none !important; }
      .modal-visible { display: flex !important; }
      /* Tailwind-like baseline for legacy classes (to avoid changing field names/structure) */
      .form-label { display:block; font-size:0.875rem; font-weight:500; color:#374151; margin-bottom:0.25rem; }
      .form-control, .form-select { display:block; width:100%; border:1px solid #d1d5db; color:#111827; border-radius:0.5rem; padding:0.75rem 1rem; }
      .form-control:focus, .form-select:focus { outline:2px solid transparent; outline-offset:2px; --tw-ring-color:#059669; box-shadow:0 0 0 2px var(--tw-ring-color); border-color:#059669; }
      .form-text, .text-muted.small { font-size:0.75rem; color:#6b7280; margin-top:0.25rem; display:block; }
      .text-danger { color:#dc2626; }
      .border-bottom { border-bottom:1px solid #e5e7eb; }
      .btn { display:inline-flex; align-items:center; justify-content:center; gap:0.5rem; border-radius:0.5rem; padding:0.75rem 1rem; font-weight:600; }
      .btn.btn-danger { background:#ef4444; color:#fff; }
      .btn.btn-danger:hover { background:#dc2626; }
      .btn.btn-lg { padding:0.875rem 1.25rem; }
      .d-flex { display:flex; }
      .flex-column { flex-direction:column; }
      .flex-sm-row { }
      @media (min-width: 640px){ .flex-sm-row { flex-direction:row; } }
      .gap-2 { gap:0.5rem; }
    </style>
  </head>
  <body class="min-h-screen flex flex-col bg-gray-100 text-gray-800">
    <!-- HEADER -->
    <nav class="bg-white shadow-lg sticky top-0 z-50" x-data="{ mobileMenuOpen: false, profileDropdownOpen: false }">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <!-- Logo -->
          <div class="flex-shrink-0 flex items-center">
            <a href="/" class="flex items-center">
              <!-- TODO: ganti src logo -->
              <img src="/assets/img/logo-alikhsan.png" class="h-16 w-auto" />
            </a>
          </div>

          <!-- Desktop Navigation -->
          <div class="hidden md:block">
            <div class="flex items-baseline space-x-4">
              <a href="/" class="text-gray-600 hover:text-brand-600 px-3 py-2 rounded-md text-sm font-medium">Beranda</a>

              <!-- Dropdown Informasi -->
              <div class="relative">
                <button @click="profileDropdownOpen=!profileDropdownOpen" class="text-gray-600 hover:text-brand-600 px-3 py-2 rounded-md text-sm font-medium flex items-center">
                  Informasi
                  <i class="bi bi-caret-down-fill ml-1 text-xs" :class="{'rotate-180': profileDropdownOpen}"></i>
                </button>
                <div x-cloak x-show="profileDropdownOpen" @click.outside="profileDropdownOpen=false" x-transition class="absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg py-2 z-50 border border-gray-100">
                  <a href="/alur-pendaftaran.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Alur Pendaftaran</a>
                  <a href="/syarat-pendaftaran.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Syarat Pendaftaran</a>
                  <a href="/biaya.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Biaya</a>
                </div>
              </div>

              <a href="/brosur.html" class="text-gray-600 hover:text-brand-600 px-3 py-2 rounded-md text-sm font-medium">Brosur</a>
              <a href="/kontak.html" class="text-gray-600 hover:text-brand-600 px-3 py-2 rounded-md text-sm font-medium">Kontak</a>
            </div>
          </div>

          <!-- CTA Button Desktop -->
          <div class="hidden md:block">
            <a href="/login" class="bg-brand-700 hover:bg-brand-800 text-white px-6 py-2 rounded-lg text-sm font-medium shadow-md hover:shadow-lg">Admin</a>
          </div>

          <!-- Mobile menu button -->
          <div class="md:hidden">
            <button @click="mobileMenuOpen=!mobileMenuOpen" class="inline-flex items-center justify-center p-2 rounded-md text-gray-600 hover:text-brand-600 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-brand-500">
              <i class="bi" :class="mobileMenuOpen ? 'bi-x-lg' : 'bi-list'"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Mobile Backdrop -->
      <div x-cloak x-show="mobileMenuOpen" @click="mobileMenuOpen=false" class="md:hidden fixed inset-0 z-40 bg-black/50"></div>

      <!-- Mobile Menu -->
      <div x-cloak x-show="mobileMenuOpen" x-transition class="md:hidden fixed inset-y-0 left-0 z-50 mobile-menu bg-white shadow-xl border-r border-gray-200 overflow-y-auto">
        <div class="flex items-center justify-between p-4 border-b border-gray-200">
          <div class="flex items-center">
            <img src="/assets/img/logo-alikhsan.png" class="h-16 w-auto" />
          </div>
          <button @click="mobileMenuOpen=false" class="p-2 rounded-md text-gray-500 hover:text-gray-700 hover:bg-gray-100"><i class="bi bi-x-lg"></i></button>
        </div>

        <div class="px-2 pt-4 pb-3 space-y-1">
          <a href="/" class="bg-brand-100 text-brand-700 block px-3 py-2 rounded-md text-base font-medium">Beranda</a>

          <details class="px-1">
            <summary class="cursor-pointer text-gray-700 hover:text-brand-700 hover:bg-gray-50 px-3 py-2 rounded-md text-base font-medium">Informasi</summary>
            <div class="pl-6 space-y-1 mt-2">
              <a href="/alur-pendaftaran.html" class="block px-3 py-2 text-sm rounded-md hover:bg-gray-50">Alur Pendaftaran</a>
              <a href="/syarat-pendaftaran.html" class="block px-3 py-2 text-sm rounded-md hover:bg-gray-50">Syarat Pendaftaran</a>
              <a href="/biaya.html" class="block px-3 py-2 text-sm rounded-md hover:bg-gray-50">Biaya</a>
            </div>
          </details>

          <a href="/brosur.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-gray-50">Brosur</a>
          <a href="/kontak.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-gray-50">Kontak</a>

          <div class="pt-4 pb-2 px-2">
            <a href="/login.html" class="w-full bg-brand-700 hover:bg-brand-800 text-white px-4 py-3 rounded-lg text-base font-medium shadow-md hover:shadow-lg block text-center">Admin</a>
          </div>
        </div>
      </div>
    </nav>

    <!-- MAIN -->
    <main class="flex-1 container mx-auto px-4 py-8">
      <div class="max-w-3xl mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-3xl font-bold text-gray-900 mb-6 text-center">Formulir Pendaftaran</h1>
        <p class="text-center text-gray-600 mb-6">Silakan isi formulir di bawah ini dengan lengkap dan benar.</p>

        <form id="formPendaftar" class="space-y-6" novalidate>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Data Pribadi -->
            <div class="col-span-full">
              <h5 class="text-lg font-semibold text-gray-800 border-bottom pb-2 mb-3">
                Data Pribadi Calon Siswa
              </h5>
            </div>

            <div class="col-md-6">
              <label class="form-label"
                >NIK Calon Siswa
                <span class="text-danger">*</span></label
              >
              <input
                type="text"
                class="form-control"
                name="nikCalon"
                required
                maxlength="16"
                pattern="[0-9]{16}"
              />
              <div class="form-text">16 digit</div>
            </div>


            <div class="col-md-6">
              <label class="form-label"
                >NISN <span class="text-danger">*</span></label
              >
              <input
                type="text"
                class="form-control"
                name="nisn"
                maxlength="10"
                required
              />
            </div>

            <div class="col-md-6">
              <label class="form-label"
                >Nama Lengkap <span class="text-danger">*</span></label
              >
              <input
                type="text"
                class="form-control"
                name="namaLengkap"
                required
              />
            </div>

            <div class="col-md-3">
              <label class="form-label"
                >Provinsi Tempat Lahir
                <span class="text-danger">*</span></label
              >
              <select
                class="form-select"
                id="provinsiTempatLahir"
                name="provinsiTempatLahir"
                required
              >
                <option value="">Pilih Provinsi...</option>
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label"
                >Kota/Kab Tempat Lahir
                <span class="text-danger">*</span></label
              >
              <select
                class="form-select"
                id="tempatLahir"
                name="tempatLahir"
                required
                disabled
              >
                <option value="">Pilih Provinsi Dulu...</option>
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label"
                >Tanggal Lahir <span class="text-danger">*</span></label
              >
              <input
                type="date"
                class="form-control"
                name="tanggalLahir"
                required
              />
            </div>

            <div class="col-md-3">
              <label class="form-label"
                >Jenis Kelamin <span class="text-danger">*</span></label
              >
              <select class="form-select" name="jenisKelamin" required>
                <option value="">Pilih...</option>
                <option value="L">Laki-laki</option>
                <option value="P">Perempuan</option>
              </select>
            </div>

            <!-- Alamat -->
            <div class="col-span-full mt-4">
              <h5 class="text-lg font-semibold text-gray-800 border-bottom pb-2 mb-3">Alamat</h5>
            </div>

            <div class="col-12">
              <label class="form-label"
                >Alamat Jalan <span class="text-danger">*</span></label
              >
              <input
                type="text"
                class="form-control"
                name="alamatJalan"
                placeholder="Contoh: Jl. Merdeka No. 123"
                required
              />
            </div>

            <div class="col-md-6">
              <label class="form-label"
                >Provinsi <span class="text-danger">*</span></label
              >
              <select class="form-select" id="provinsiAlamat" required>
                <option value="">Pilih Provinsi...</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label"
                >Kota/Kabupaten <span class="text-danger">*</span></label
              >
              <select
                class="form-select"
                id="kotaAlamat"
                required
                disabled
              >
                <option value="">Pilih Provinsi Dulu...</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label"
                >Kecamatan <span class="text-danger">*</span></label
              >
              <select
                class="form-select"
                id="kecamatanAlamat"
                required
                disabled
              >
                <option value="">Pilih Kota Dulu...</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label"
                >Desa/Kelurahan <span class="text-danger">*</span></label
              >
              <select
                class="form-select"
                id="desaAlamat"
                name="desa"
                required
                disabled
              >
                <option value="">Pilih Kecamatan Dulu...</option>
              </select>
            </div>

            <!-- Pendidikan -->
            <div class="col-span-full mt-4">
              <h5 class="text-lg font-semibold text-gray-800 border-bottom pb-2 mb-3">
                Pendidikan & Rencana
              </h5>
            </div>

            <div class="col-md-6">
              <label class="form-label"
                >Ijazah Formal Terakhir
                <span class="text-danger">*</span></label
              >
              <select
                class="form-select"
                name="ijazahFormalTerakhir"
                required
              >
                <option value="">Pilih...</option>
                <option value="SD">SD/MI</option>
                <option value="SMP">SMP/MTs</option>
                <option value="SMA">SMA/MA</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label"
                >Tingkat Pendidikan <span class="text-danger">*</span></label
              >
              <select
                class="form-select"
                id="rencanaTingkat"
                name="rencanaTingkat"
                required
                onchange="handleTingkatChange()"
              >
                <option value="">Pilih...</option>
                <option value="MTs">MTs (Tsanawiyah)</option>
                <option value="MA">MA (Aliyah)</option>
                <option value="Kuliah">Kuliah</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label"
                >Jenis Asrama <span class="text-danger">*</span></label
              >
              <select
                class="form-select"
                id="rencanaProgram"
                name="rencanaProgram"
                required
              >
                <option value="">Pilih...</option>
                <option value="Asrama Putra Induk">
                  Asrama Putra Induk
                </option>
                <option value="Asrama Putra Tahfidz">
                  Asrama Putra Tahfidz
                </option>
                <option value="Asrama Putri">Asrama Putri</option>
                <option value="Hanya Sekolah" id="optionHanyaSekolah">
                  Non Asrama
                </option>
              </select>
            </div>

            <!-- Data Orang Tua -->
            <div class="col-span-full mt-4">
              <h5 class="text-lg font-semibold text-gray-800 border-bottom pb-2 mb-3">Data Orang Tua</h5>
            </div>

            <div class="col-md-6">
              <label class="form-label"
                >Nama Ayah <span class="text-danger">*</span></label
              >
              <input
                type="text"
                class="form-control"
                name="namaAyah"
                required
              />
            </div>

            <div class="col-md-6">
              <label class="form-label"
                >NIK Ayah <span class="text-danger">*</span></label
              >
              <input
                type="text"
                class="form-control"
                name="nikAyah"
                required
                maxlength="16"
                pattern="[0-9]{16}"
              />
            </div>

            <div class="col-md-6">
              <label class="form-label"
                >Status Ayah <span class="text-danger">*</span></label
              >
              <select class="form-select" name="statusAyah" required>
                <option value="">Pilih...</option>
                <option value="Hidup">Hidup</option>
                <option value="Meninggal">Meninggal</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label"
                >Pekerjaan Ayah <span class="text-danger">*</span></label
              >
              <select class="form-select" name="pekerjaanAyah" required>
                <option value="">Pilih...</option>
                <option value="PNS">PNS</option>
                <option value="TNI/Polri">TNI/Polri</option>
                <option value="Guru/Dosen">Guru/Dosen</option>
                <option value="Pegawai Swasta">Pegawai Swasta</option>
                <option value="Wiraswasta">Wiraswasta</option>
                <option value="Petani">Petani</option>
                <option value="Nelayan">Nelayan</option>
                <option value="Pedagang">Pedagang</option>
                <option value="Buruh">Buruh</option>
                <option value="Sopir">Sopir</option>
                <option value="Tukang">Tukang</option>
                <option value="Pensiunan">Pensiunan</option>
                <option value="Tidak Bekerja">Tidak Bekerja</option>
                <option value="Lainnya">Lainnya</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label"
                >Nama Ibu <span class="text-danger">*</span></label
              >
              <input
                type="text"
                class="form-control"
                name="namaIbu"
                required
              />
            </div>

            <div class="col-md-6">
              <label class="form-label"
                >NIK Ibu <span class="text-danger">*</span></label
              >
              <input
                type="text"
                class="form-control"
                name="nikIbu"
                required
                maxlength="16"
                pattern="[0-9]{16}"
              />
            </div>

            <div class="col-md-6">
              <label class="form-label"
                >Status Ibu <span class="text-danger">*</span></label
              >
              <select class="form-select" name="statusIbu" required>
                <option value="">Pilih...</option>
                <option value="Hidup">Hidup</option>
                <option value="Meninggal">Meninggal</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label"
                >Pekerjaan Ibu <span class="text-danger">*</span></label
              >
              <select class="form-select" name="pekerjaanIbu" required>
                <option value="">Pilih...</option>
                <option value="PNS">PNS</option>
                <option value="TNI/Polri">TNI/Polri</option>
                <option value="Guru/Dosen">Guru/Dosen</option>
                <option value="Pegawai Swasta">Pegawai Swasta</option>
                <option value="Wiraswasta">Wiraswasta</option>
                <option value="Petani">Petani</option>
                <option value="Pedagang">Pedagang</option>
                <option value="Ibu Rumah Tangga">Ibu Rumah Tangga</option>
                <option value="Buruh">Buruh</option>
                <option value="Pensiunan">Pensiunan</option>
                <option value="Tidak Bekerja">Tidak Bekerja</option>
                <option value="Lainnya">Lainnya</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label"
                >No Telepon Orang Tua
                <span class="text-danger">*</span></label
              >
              <input
                type="tel"
                class="form-control"
                name="teleponOrtu"
                required
              />
            </div>

            <!-- Upload Berkas -->
            <div class="col-span-full mt-4">
              <h5 class="text-lg font-semibold text-gray-800 border-bottom pb-2 mb-3">
                <i class="bi bi-file-earmark-arrow-up"></i> Upload Berkas
                (Opsional)
              </h5>
              <p class="text-muted small">
                Format: PDF, JPG, PNG. Maksimal 2MB per file.
              </p>
            </div>

            <div class="col-md-6">
              <label class="form-label">
                <i class="bi bi-file-pdf"></i> Scan Ijazah Terakhir
                <span class="text-danger">*</span>
              </label>
              <input
                type="file"
                class="form-control"
                name="fileIjazah"
                accept=".pdf,.jpg,.jpeg,.png"
                required
              />
              <small class="text-muted"
                >PDF, JPG, atau PNG (max 2MB)</small
              >
            </div>

            <div class="col-md-6">
              <label class="form-label">
                <i class="bi bi-file-pdf"></i> Scan Akta Kelahiran
                <span class="text-danger">*</span>
              </label>
              <input
                type="file"
                class="form-control"
                name="fileAkta"
                accept=".pdf,.jpg,.jpeg,.png"
                required
              />
              <small class="text-muted"
                >PDF, JPG, atau PNG (max 2MB)</small
              >
            </div>

            <div class="col-md-6">
              <label class="form-label">
                <i class="bi bi-image"></i> Pas Foto 3x4
                <span class="text-danger">*</span>
              </label>
              <input
                type="file"
                class="form-control"
                name="fileFoto"
                accept=".jpg,.jpeg,.png"
                required
              />
              <small class="text-muted">JPG atau PNG (max 2MB)</small>
            </div>

            <div class="col-md-6">
              <label class="form-label">
                <i class="bi bi-file-medical"></i> Kartu BPJS
                <span class="text-muted">(Opsional)</span>
              </label>
              <input
                type="file"
                class="form-control"
                name="fileBPJS"
                accept=".pdf,.jpg,.jpeg,.png"
              />
              <small class="text-muted">PDF, JPG, atau PNG (max 2MB) - Tidak wajib</small>
            </div>
          </div>

          <div class="mt-4 flex flex-col sm:flex-row gap-2">
            <button
              id="btnLanjutKonfirmasi"
              class="inline-flex items-center justify-center gap-2 bg-brand-600 hover:bg-brand-700 text-white px-5 py-3 rounded-lg w-full sm:w-auto"
              type="button"
            >
              <i class="bi bi-check-circle"></i> Lanjut ke Konfirmasi
            </button>
            <a href="/" class="inline-flex items-center justify-center gap-2 bg-red-600 hover:bg-red-700 text-white px-5 py-3 rounded-lg w-full sm:w-auto">
              <i class="bi bi-arrow-left"></i> Kembali
            </a>
          </div>
        </form>
      </div>
    </main>

    <!-- Modal Sukses -->
    <div id="modalSukses" class="modal-hidden fixed inset-0 z-50 flex items-center justify-center">
      <div class="absolute inset-0 bg-black/50"></div>
      <div class="relative bg-white rounded-2xl shadow-2xl max-w-lg w-[92vw]">
        <div class="px-6 py-4 bg-green-600 text-white rounded-t-2xl">
          <h5 class="font-semibold"><i class="bi bi-check-circle-fill"></i> Pendaftaran Berhasil!</h5>
        </div>
        <div class="p-6 text-center">
          <div class="mb-4">
            <i class="bi bi-check-circle-fill text-green-600" style="font-size: 3rem"></i>
          </div>
          <h4 class="mb-2">🎉 Selamat!</h4>
          <p class="mb-3">Pendaftaran Anda telah berhasil disimpan.</p>
          <div class="mb-3 rounded-lg bg-blue-50 border border-blue-200 px-4 py-3">
            <strong>NISN Anda:</strong>
            <h3 class="text-blue-700 font-bold mb-2" id="regNo"></h3>
            <button class="inline-flex items-center gap-2 border border-blue-600 text-blue-700 hover:bg-blue-600 hover:text-white px-3 py-2 rounded" id="btnSalinReg" onclick="salinNISN()">
              <i class="bi bi-clipboard"></i> Salin NISN
            </button>
          </div>
          <p class="text-gray-500 text-sm"><i class="bi bi-info-circle"></i> Simpan NISN ini untuk tracking status pendaftaran Anda.</p>
        </div>
        <div class="px-6 py-4 flex flex-col sm:flex-row gap-2 justify-center border-t border-gray-100 rounded-b-2xl">
          <a href="/cek-status.html" class="inline-flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white px-5 py-3 rounded-lg w-full sm:w-auto">
            <i class="bi bi-search"></i> Cek Status Pendaftaran
          </a>
          <button type="button" class="inline-flex items-center justify-center gap-2 bg-gray-200 hover:bg-gray-300 text-gray-800 px-5 py-3 rounded-lg w-full sm:w-auto" onclick="window.location.reload()">
            <i class="bi bi-arrow-clockwise"></i> Daftar Lagi
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Konfirmasi -->
    <div id="modalKonfirmasi" class="modal-hidden fixed inset-0 z-50 flex items-center justify-center">
      <div class="absolute inset-0 bg-black/50" onclick="document.getElementById('modalKonfirmasi').classList.remove('modal-visible'); document.getElementById('modalKonfirmasi').classList.add('modal-hidden');"></div>
      <div class="relative bg-white rounded-2xl shadow-2xl max-w-5xl w-[92vw] max-h-[85vh] overflow-y-auto">
        <div class="px-6 py-4 bg-brand-600 text-white rounded-t-2xl flex items-center justify-between">
          <h5 class="font-semibold"><i class="bi bi-clipboard-check"></i> Konfirmasi Data Pendaftaran</h5>
          <button class="text-white/90 hover:text-white" onclick="document.getElementById('modalKonfirmasi').classList.remove('modal-visible'); document.getElementById('modalKonfirmasi').classList.add('modal-hidden');"><i class="bi bi-x-lg"></i></button>
        </div>
        <div class="p-6">
          <div class="mb-3 rounded-lg bg-yellow-50 border border-yellow-200 text-yellow-900 px-4 py-3"><i class="bi bi-exclamation-triangle"></i> <strong>Perhatian!</strong> Pastikan semua data sudah benar sebelum mengirim.</div>
          <div id="konfirmasiContent"></div>
        </div>
        <div class="px-6 py-4 flex flex-col-reverse sm:flex-row gap-2 border-t border-gray-100 rounded-b-2xl">
          <button type="button" class="inline-flex items-center justify-center gap-2 bg-gray-200 hover:bg-gray-300 text-gray-800 px-5 py-3 rounded-lg w-full sm:w-auto" onclick="document.getElementById('modalKonfirmasi').classList.remove('modal-visible'); document.getElementById('modalKonfirmasi').classList.add('modal-hidden');">
            <i class="bi bi-pencil"></i> Edit Data
          </button>
          <button id="btnKonfirmasiKirim" type="button" class="inline-flex items-center justify-center gap-2 bg-brand-600 hover:bg-brand-700 text-white px-5 py-3 rounded-lg w-full sm:w-auto" onclick="submitFinal()">
            <i class="bi bi-send"></i> Ya, Kirim Pendaftaran
          </button>
        </div>
      </div>
    </div>

    <!-- FOOTER -->
    <footer class="bg-white text-gray-600 py-6 shadow-2xl border-t border-gray-200 mt-auto">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <p class="text-sm">&copy; 2025 Pondok Pesantren Al Ikhsan Beji. All rights reserved. <span class="hidden sm:inline">Development by Tim IT Pesantren</span></p>
      </div>
    </footer>

    <!-- Vendors JS (optional) -->
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
      // Shim toastr -> toastify agar kompatibel dgn snippet lama
      window.toastr = {
        success(msg){ Toastify({ text: msg, duration: 4000, close: true, gravity: 'top', position: 'right', style: { background: '#10b981', color: '#fff' }}).showToast(); },
        error(msg){ Toastify({ text: msg, duration: 4000, close: true, gravity: 'top', position: 'right', style: { background: '#ef4444', color: '#fff' }}).showToast(); },
        warning(msg){ Toastify({ text: msg, duration: 4000, close: true, gravity: 'top', position: 'right', style: { background: '#f59e0b', color: '#fff' }}).showToast(); },
        info(msg){ Toastify({ text: msg, duration: 4000, close: true, gravity: 'top', position: 'right', style: { background: '#3b82f6', color: '#fff' }}).showToast(); }
      }
    </script>

    <!-- Custom scripts for form functionality -->
    <script>
      const form = document.getElementById("formPendaftar");
      let formDataGlobal = null;

      // Fungsi untuk mengontrol pilihan Rencana Program berdasarkan Rencana Tingkat
      function handleTingkatChange() {
        const tingkatSelect = document.getElementById("rencanaTingkat");
        const programSelect = document.getElementById("rencanaProgram");
        const hanyaSekolahOption =
          document.getElementById("optionHanyaSekolah");

        if (tingkatSelect.value === "Kuliah") {
          hanyaSekolahOption.disabled = true;
          hanyaSekolahOption.style.display = "none";

          if (programSelect.value === "Hanya Sekolah") {
            programSelect.value = "";
          }
        } else {
          hanyaSekolahOption.disabled = false;
          hanyaSekolahOption.style.display = "block";
        }
      }

      // Data wilayah Indonesia (provinsi dan kota/kabupaten)
      const wilayahIndonesia = {
        Aceh: [
          "Banda Aceh",
          "Sabang",
          "Lhokseumawe",
          "Langsa",
          "Aceh Besar",
          "Aceh Barat",
          "Aceh Selatan",
          "Aceh Tengah",
          "Aceh Timur",
          "Aceh Utara",
        ],
        "Sumatera Utara": [
          "Medan",
          "Binjai",
          "Pematang Siantar",
          "Tebing Tinggi",
          "Tanjung Balai",
          "Deli Serdang",
          "Karo",
          "Labuhanbatu",
          "Simalungun",
          "Tapanuli Utara",
        ],
        "Sumatera Barat": [
          "Padang",
          "Bukittinggi",
          "Padang Panjang",
          "Payakumbuh",
          "Solok",
          "Agam",
          "Lima Puluh Kota",
          "Pasaman",
          "Sijunjung",
          "Tanah Datar",
        ],
        Riau: [
          "Pekanbaru",
          "Dumai",
          "Bengkalis",
          "Indragiri Hilir",
          "Kampar",
          "Pelalawan",
          "Rokan Hilir",
          "Rokan Hulu",
          "Siak",
          "Kuantan Singingi",
        ],
        "Kepulauan Riau": [
          "Batam",
          "Tanjung Pinang",
          "Bintan",
          "Karimun",
          "Lingga",
          "Natuna",
          "Kepulauan Anambas",
        ],
        Jambi: [
          "Jambi",
          "Sungai Penuh",
          "Batang Hari",
          "Bungo",
          "Kerinci",
          "Merangin",
          "Muaro Jambi",
          "Sarolangun",
          "Tanjung Jabung Barat",
          "Tanjung Jabung Timur",
          "Tebo",
        ],
        "Sumatera Selatan": [
          "Palembang",
          "Lubuklinggau",
          "Pagar Alam",
          "Prabumulih",
          "Banyuasin",
          "Empat Lawang",
          "Lahat",
          "Muara Enim",
          "Musi Banyuasin",
          "Ogan Ilir",
          "Ogan Komering Ilir",
          "Ogan Komering Ulu",
        ],
        "Bangka Belitung": [
          "Pangkal Pinang",
          "Bangka",
          "Bangka Barat",
          "Bangka Selatan",
          "Bangka Tengah",
          "Belitung",
          "Belitung Timur",
        ],
        Bengkulu: [
          "Bengkulu",
          "Bengkulu Selatan",
          "Bengkulu Tengah",
          "Bengkulu Utara",
          "Kaur",
          "Kepahiang",
          "Lebong",
          "Mukomuko",
          "Rejang Lebong",
          "Seluma",
        ],
        Lampung: [
          "Bandar Lampung",
          "Metro",
          "Lampung Barat",
          "Lampung Selatan",
          "Lampung Tengah",
          "Lampung Timur",
          "Lampung Utara",
          "Pesawaran",
          "Pringsewu",
          "Tanggamus",
          "Tulang Bawang",
          "Way Kanan",
        ],
        "DKI Jakarta": [
          "Jakarta Pusat",
          "Jakarta Utara",
          "Jakarta Barat",
          "Jakarta Selatan",
          "Jakarta Timur",
          "Kepulauan Seribu",
        ],
        Banten: [
          "Tangerang",
          "Tangerang Selatan",
          "Cilegon",
          "Serang",
          "Lebak",
          "Pandeglang",
        ],
        "Jawa Barat": [
          "Bandung",
          "Bekasi",
          "Bogor",
          "Cimahi",
          "Cirebon",
          "Depok",
          "Sukabumi",
          "Tasikmalaya",
          "Bandung Barat",
          "Ciamis",
          "Cianjur",
          "Garut",
          "Indramayu",
          "Karawang",
          "Kuningan",
          "Majalengka",
          "Purwakarta",
          "Subang",
          "Sumedang",
        ],
        "Jawa Tengah": [
          "Semarang",
          "Magelang",
          "Pekalongan",
          "Salatiga",
          "Surakarta",
          "Tegal",
          "Banjarnegara",
          "Banyumas",
          "Batang",
          "Blora",
          "Boyolali",
          "Brebes",
          "Cilacap",
          "Demak",
          "Grobogan",
          "Jepara",
          "Karanganyar",
          "Kebumen",
          "Kendal",
          "Klaten",
          "Kudus",
          "Pati",
          "Pemalang",
          "Purbalingga",
          "Purworejo",
          "Rembang",
          "Sragen",
          "Sukoharjo",
          "Temanggung",
          "Wonogiri",
          "Wonosobo",
        ],
        "DI Yogyakarta": [
          "Yogyakarta",
          "Bantul",
          "Gunungkidul",
          "Kulon Progo",
          "Sleman",
        ],
        "Jawa Timur": [
          "Surabaya",
          "Batu",
          "Blitar",
          "Kediri",
          "Madiun",
          "Malang",
          "Mojokerto",
          "Pasuruan",
          "Probolinggo",
          "Bangkalan",
          "Banyuwangi",
          "Bojonegoro",
          "Bondowoso",
          "Gresik",
          "Jember",
          "Jombang",
          "Lamongan",
          "Lumajang",
          "Magetan",
          "Mojokerto",
          "Nganjuk",
          "Ngawi",
          "Pacitan",
          "Pamekasan",
          "Pasuruan",
          "Ponorogo",
          "Probolinggo",
          "Sampang",
          "Sidoarjo",
          "Situbondo",
          "Sumenep",
          "Trenggalek",
          "Tuban",
          "Tulungagung",
        ],
        Bali: [
          "Denpasar",
          "Badung",
          "Bangli",
          "Buleleng",
          "Gianyar",
          "Jembrana",
          "Karangasem",
          "Klungkung",
          "Tabanan",
        ],
        "Nusa Tenggara Barat": [
          "Mataram",
          "Bima",
          "Dompu",
          "Lombok Barat",
          "Lombok Tengah",
          "Lombok Timur",
          "Lombok Utara",
          "Sumbawa",
          "Sumbawa Barat",
        ],
        "Nusa Tenggara Timur": [
          "Kupang",
          "Alor",
          "Belu",
          "Ende",
          "Flores Timur",
          "Kupang",
          "Lembata",
          "Manggarai",
          "Manggarai Barat",
          "Manggarai Timur",
          "Nagekeo",
          "Ngada",
          "Rote Ndao",
          "Sabu Raijua",
          "Sikka",
          "Sumba Barat",
          "Sumba Tengah",
          "Sumba Timur",
          "Timor Tengah Selatan",
          "Timor Tengah Utara",
        ],
        "Kalimantan Barat": [
          "Pontianak",
          "Singkawang",
          "Bengkayang",
          "Kapuas Hulu",
          "Kayong Utara",
          "Ketapang",
          "Kubu Raya",
          "Landak",
          "Melawi",
          "Sambas",
          "Sanggau",
          "Sekadau",
          "Sintang",
        ],
        "Kalimantan Tengah": [
          "Palangkaraya",
          "Barito Selatan",
          "Barito Timur",
          "Barito Utara",
          "Gunung Mas",
          "Kapuas",
          "Katingan",
          "Kotawaringin Barat",
          "Kotawaringin Timur",
          "Lamandau",
          "Murung Raya",
          "Pulang Pisau",
          "Seruyan",
          "Sukamara",
        ],
        "Kalimantan Selatan": [
          "Banjarmasin",
          "Banjarbaru",
          "Balangan",
          "Banjar",
          "Barito Kuala",
          "Hulu Sungai Selatan",
          "Hulu Sungai Tengah",
          "Hulu Sungai Utara",
          "Kotabaru",
          "Tabalong",
          "Tanah Bumbu",
          "Tanah Laut",
          "Tapin",
        ],
        "Kalimantan Timur": [
          "Balikpapan",
          "Bontang",
          "Samarinda",
          "Berau",
          "Kutai Barat",
          "Kutai Kartanegara",
          "Kutai Timur",
          "Mahakam Ulu",
          "Paser",
          "Penajam Paser Utara",
        ],
        "Kalimantan Utara": [
          "Tarakan",
          "Bulungan",
          "Malinau",
          "Nunukan",
          "Tana Tidung",
        ],
        "Sulawesi Utara": [
          "Manado",
          "Bitung",
          "Kotamobagu",
          "Tomohon",
          "Bolaang Mongondow",
          "Bolaang Mongondow Selatan",
          "Bolaang Mongondow Timur",
          "Bolaang Mongondow Utara",
          "Kepulauan Sangihe",
          "Kepulauan Siau Tagulandang Biaro",
          "Kepulauan Talaud",
          "Minahasa",
          "Minahasa Selatan",
          "Minahasa Tenggara",
          "Minahasa Utara",
        ],
        "Sulawesi Barat": [
          "Majene",
          "Mamasa",
          "Mamuju",
          "Mamuju Tengah",
          "Pasangkayu",
          "Polewali Mandar",
        ],
        "Sulawesi Tengah": [
          "Palu",
          "Banggai",
          "Banggai Kepulauan",
          "Banggai Laut",
          "Buol",
          "Donggala",
          "Morowali",
          "Morowali Utara",
          "Parigi Moutong",
          "Poso",
          "Sigi",
          "Tojo Una-Una",
          "Toli-Toli",
        ],
        "Sulawesi Tenggara": [
          "Kendari",
          "Bau-Bau",
          "Bombana",
          "Buton",
          "Buton Selatan",
          "Buton Tengah",
          "Buton Utara",
          "Kolaka",
          "Kolaka Timur",
          "Kolaka Utara",
          "Konawe",
          "Konawe Kepulauan",
          "Konawe Selatan",
          "Konawe Utara",
          "Muna",
          "Muna Barat",
          "Wakatobi",
        ],
        "Sulawesi Selatan": [
          "Makassar",
          "Palopo",
          "Parepare",
          "Bantaeng",
          "Barru",
          "Bone",
          "Bulukumba",
          "Enrekang",
          "Gowa",
          "Jeneponto",
          "Kepulauan Selayar",
          "Luwu",
          "Luwu Timur",
          "Luwu Utara",
          "Maros",
          "Pangkajene dan Kepulauan",
          "Pinrang",
          "Sidenreng Rappang",
          "Sinjai",
          "Soppeng",
          "Takalar",
          "Tana Toraja",
          "Toraja Utara",
          "Wajo",
        ],
        Gorontalo: [
          "Gorontalo",
          "Boalemo",
          "Bone Bolango",
          "Gorontalo Utara",
          "Pohuwato",
        ],
        Maluku: [
          "Ambon",
          "Tual",
          "Buru",
          "Buru Selatan",
          "Kepulauan Aru",
          "Maluku Barat Daya",
          "Maluku Tengah",
          "Maluku Tenggara",
          "Maluku Tenggara Barat",
          "Seram Bagian Barat",
          "Seram Bagian Timur",
        ],
        "Maluku Utara": [
          "Ternate",
          "Tidore Kepulauan",
          "Halmahera Barat",
          "Halmahera Tengah",
          "Halmahera Timur",
          "Halmahera Selatan",
          "Halmahera Utara",
          "Kepulauan Sula",
          "Pulau Morotai",
          "Pulau Taliabu",
        ],
        Papua: [
          "Jayapura",
          "Asmat",
          "Biak Numfor",
          "Boven Digoel",
          "Deiyai",
          "Dogiyai",
          "Intan Jaya",
          "Jayapura",
          "Jayawijaya",
          "Keerom",
          "Kepulauan Yapen",
          "Lanny Jaya",
          "Mamberamo Raya",
          "Mamberamo Tengah",
          "Mappi",
          "Merauke",
          "Mimika",
          "Nabire",
          "Nduga",
          "Paniai",
          "Pegunungan Bintang",
          "Puncak",
          "Puncak Jaya",
          "Sarmi",
          "Supiori",
          "Tolikara",
          "Waropen",
          "Yahukimo",
          "Yalimo",
        ],
        "Papua Barat": [
          "Manokwari",
          "Sorong",
          "Fakfak",
          "Kaimana",
          "Manokwari Selatan",
          "Maybrat",
          "Pegunungan Arfak",
          "Raja Ampat",
          "Sorong Selatan",
          "Tambrauw",
          "Teluk Bintuni",
          "Teluk Wondama",
        ],
        "Papua Selatan": ["Merauke", "Asmat", "Boven Digoel", "Mappi"],
        "Papua Tengah": [
          "Nabire",
          "Dogiyai",
          "Intan Jaya",
          "Mimika",
          "Paniai",
          "Puncak",
          "Puncak Jaya",
          "Deiyai",
        ],
        "Papua Pegunungan": [
          "Jayawijaya",
          "Lanny Jaya",
          "Mamberamo Tengah",
          "Nduga",
          "Tolikara",
          "Yalimo",
          "Yahukimo",
          "Pegunungan Bintang",
        ],
      };

      // Populate provinsi dropdown untuk tempat lahir
      const provinsiTempatLahirSelect = document.getElementById(
        "provinsiTempatLahir"
      );
      const tempatLahirSelect = document.getElementById("tempatLahir");

      Object.keys(wilayahIndonesia)
        .sort()
        .forEach((prov) => {
          const option = document.createElement("option");
          option.value = prov;
          option.textContent = prov;
          provinsiTempatLahirSelect.appendChild(option);
        });

      // Event listener untuk provinsi tempat lahir
      provinsiTempatLahirSelect.addEventListener("change", function () {
        const selectedProv = this.value;
        tempatLahirSelect.innerHTML =
          '<option value="">Pilih Kota/Kabupaten...</option>';
        tempatLahirSelect.disabled = false;

        if (selectedProv && wilayahIndonesia[selectedProv]) {
          wilayahIndonesia[selectedProv].sort().forEach((kota) => {
            const option = document.createElement("option");
            option.value = kota;
            option.textContent = kota;
            tempatLahirSelect.appendChild(option);
          });
        } else {
          tempatLahirSelect.disabled = true;
          tempatLahirSelect.innerHTML =
            '<option value="">Pilih Provinsi Dulu...</option>';
        }
      });

      // Alamat wilayah dengan API Indonesia
      const provinsiAlamatSelect = document.getElementById("provinsiAlamat");
      const kotaAlamatSelect = document.getElementById("kotaAlamat");
      const kecamatanAlamatSelect = document.getElementById("kecamatanAlamat");
      const desaAlamatSelect = document.getElementById("desaAlamat");

      // Load provinsi dari API
      async function loadProvinsi() {
        try {
          const response = await fetch(
            "https://www.emsifa.com/api-wilayah-indonesia/api/provinces.json"
          );
          const provinsi = await response.json();

          provinsi.forEach((prov) => {
            const option = document.createElement("option");
            option.value = prov.id;
            option.textContent = prov.name;
            option.dataset.name = prov.name;
            provinsiAlamatSelect.appendChild(option);
          });
        } catch (error) {
          console.error("Error loading provinsi:", error);
          toastr.error("Gagal memuat data provinsi");
        }
      }

      // Load kota/kabupaten berdasarkan provinsi
      async function loadKota(provinsiId) {
        try {
          kotaAlamatSelect.innerHTML = '<option value="">Memuat...</option>';
          const response = await fetch(
            `https://www.emsifa.com/api-wilayah-indonesia/api/regencies/${provinsiId}.json`
          );
          const kota = await response.json();

          kotaAlamatSelect.innerHTML =
            '<option value="">Pilih Kota/Kabupaten...</option>';
          kota.forEach((k) => {
            const option = document.createElement("option");
            option.value = k.id;
            option.textContent = k.name;
            option.dataset.name = k.name;
            kotaAlamatSelect.appendChild(option);
          });
          kotaAlamatSelect.disabled = false;
        } catch (error) {
          console.error("Error loading kota:", error);
          toastr.error("Gagal memuat data kota");
        }
      }

      // Load kecamatan berdasarkan kota
      async function loadKecamatan(kotaId) {
        try {
          kecamatanAlamatSelect.innerHTML =
            '<option value="">Memuat...</option>';
          const response = await fetch(
            `https://www.emsifa.com/api-wilayah-indonesia/api/districts/${kotaId}.json`
          );
          const kecamatan = await response.json();

          kecamatanAlamatSelect.innerHTML =
            '<option value="">Pilih Kecamatan...</option>';
          kecamatan.forEach((kec) => {
            const option = document.createElement("option");
            option.value = kec.id;
            option.textContent = kec.name;
            option.dataset.name = kec.name;
            kecamatanAlamatSelect.appendChild(option);
          });
          kecamatanAlamatSelect.disabled = false;
        } catch (error) {
          console.error("Error loading kecamatan:", error);
          toastr.error("Gagal memuat data kecamatan");
        }
      }

      // Load desa/kelurahan berdasarkan kecamatan
      async function loadDesa(kecamatanId) {
        try {
          desaAlamatSelect.innerHTML = '<option value="">Memuat...</option>';
          const response = await fetch(
            `https://www.emsifa.com/api-wilayah-indonesia/api/villages/${kecamatanId}.json`
          );
          const desa = await response.json();

          desaAlamatSelect.innerHTML =
            '<option value="">Pilih Desa/Kelurahan...</option>';
          desa.forEach((d) => {
            const option = document.createElement("option");
            option.value = d.name;
            option.textContent = d.name;
            desaAlamatSelect.appendChild(option);
          });
          desaAlamatSelect.disabled = false;
        } catch (error) {
          console.error("Error loading desa:", error);
          toastr.error("Gagal memuat data desa");
        }
      }

      // Event listeners untuk dropdown alamat
      provinsiAlamatSelect.addEventListener("change", function () {
        const provinsiId = this.value;
        const provinsiName = this.options[this.selectedIndex].dataset.name;

        document.querySelector('input[name="provinsi"]')?.remove();
        if (provinsiName) {
          const hiddenInput = document.createElement("input");
          hiddenInput.type = "hidden";
          hiddenInput.name = "provinsi";
          hiddenInput.value = provinsiName;
          form.appendChild(hiddenInput);
        }

        kotaAlamatSelect.innerHTML =
          '<option value="">Pilih Provinsi Dulu...</option>';
        kotaAlamatSelect.disabled = true;
        kecamatanAlamatSelect.innerHTML =
          '<option value="">Pilih Kota Dulu...</option>';
        kecamatanAlamatSelect.disabled = true;
        desaAlamatSelect.innerHTML =
          '<option value="">Pilih Kecamatan Dulu...</option>';
        desaAlamatSelect.disabled = true;

        if (provinsiId) {
          loadKota(provinsiId);
        }
      });

      kotaAlamatSelect.addEventListener("change", function () {
        const kotaId = this.value;
        const kotaName = this.options[this.selectedIndex].dataset.name;

        document.querySelector('input[name="kotaKabupaten"]')?.remove();
        if (kotaName) {
          const hiddenInput = document.createElement("input");
          hiddenInput.type = "hidden";
          hiddenInput.name = "kotaKabupaten";
          hiddenInput.value = kotaName;
          form.appendChild(hiddenInput);
        }

        kecamatanAlamatSelect.innerHTML =
          '<option value="">Pilih Kota Dulu...</option>';
        kecamatanAlamatSelect.disabled = true;
        desaAlamatSelect.innerHTML =
          '<option value="">Pilih Kecamatan Dulu...</option>';
        desaAlamatSelect.disabled = true;

        if (kotaId) {
          loadKecamatan(kotaId);
        }
      });

      kecamatanAlamatSelect.addEventListener("change", function () {
        const kecamatanId = this.value;
        const kecamatanName = this.options[this.selectedIndex].dataset.name;

        document.querySelector('input[name="kecamatan"]')?.remove();
        if (kecamatanName) {
          const hiddenInput = document.createElement("input");
          hiddenInput.type = "hidden";
          hiddenInput.name = "kecamatan";
          hiddenInput.value = kecamatanName;
          form.appendChild(hiddenInput);
        }

        desaAlamatSelect.innerHTML =
          '<option value="">Pilih Kecamatan Dulu...</option>';
        desaAlamatSelect.disabled = true;

        if (kecamatanId) {
          loadDesa(kecamatanId);
        }
      });

      // Load provinsi saat halaman dimuat
      loadProvinsi();

      // Attach event listener to konfirmasi button
      const btnKonfirmasi = document.getElementById('btnLanjutKonfirmasi');
      if (btnKonfirmasi) {
        btnKonfirmasi.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('[BUTTON] Konfirmasi button clicked via event listener');
          showKonfirmasi();
        });
        console.log('[INIT] Konfirmasi button event listener attached');
      } else {
        console.error('[INIT] Konfirmasi button not found!');
      }

      // Function to show konfirmasi modal
      function showKonfirmasi() {
        console.log('[KONFIRMASI] Function called');
        
        // Validate form first
        if (!form.checkValidity()) {
          console.warn('[KONFIRMASI] Form validation failed');
          form.classList.add("was-validated");
          
          // Find first invalid field
          const invalidField = form.querySelector(':invalid');
          if (invalidField) {
            const fieldName = invalidField.name || invalidField.id || 'Unknown';
            console.warn('[KONFIRMASI] First invalid field:', fieldName, invalidField);
            invalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            invalidField.focus();
          }
          
          toastr.error("Mohon lengkapi semua field yang wajib diisi!");
          return;
        }
        
        console.log('[KONFIRMASI] Form valid, building modal...');

        try {
          const formData = new FormData(form);
          formDataGlobal = formData;

        // Build konfirmasi HTML
        let html = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Data Calon Santri -->
            <div class="col-span-full">
              <h6 class="bg-brand-600 text-white p-2 rounded">
                <i class="bi bi-person"></i> Data Calon Siswa
              </h6>
            </div>
            <div>
              <strong>NIK Calon:</strong><br>${formData.get("nikCalon") || "-"}
            </div>
            <div class="col-span-full">
              <strong>Nama Lengkap:</strong><br>
              <span class="text-xl text-brand-700">${
                formData.get("namaLengkap") || "-"
              }</span>
            </div>
            <div>
              <strong>Tempat Lahir:</strong><br>${
                formData.get("tempatLahir") || "-"
              }, ${formData.get("provinsiTempatLahir") || "-"}
            </div>
            <div>
              <strong>Tanggal Lahir:</strong><br>${
                formData.get("tanggalLahir") || "-"
              }
            </div>
            <div>
              <strong>Jenis Kelamin:</strong><br>${
                formData.get("jenisKelamin") === "L" ? "Laki-laki" : "Perempuan"
              }
            </div>

            <!-- Alamat -->
            <div class="col-span-full mt-3">
              <h6 class="bg-brand-600 text-white p-2 rounded">
                <i class="bi bi-geo-alt"></i> Alamat
              </h6>
            </div>
            <div class="col-span-full">
              <strong>Alamat Lengkap:</strong><br>
              ${formData.get("alamatJalan") || "-"}, ${
          formData.get("desa") || "-"
        }, ${formData.get("kecamatan") || "-"}, ${
          formData.get("kotaKabupaten") || "-"
        }, ${formData.get("provinsi") || "-"}
            </div>

            <!-- Pendidikan -->
            <div class="col-span-full mt-3">
              <h6 class="bg-brand-600 text-white p-2 rounded">
                <i class="bi bi-mortarboard"></i> Pendidikan & Rencana
              </h6>
            </div>
            <div>
              <strong>Ijazah Formal Terakhir:</strong><br>${
                formData.get("ijazahFormalTerakhir") || "-"
              }
            </div>
            <div>
              <strong>Rencana Tingkat:</strong><br>${
                formData.get("rencanaTingkat") || "-"
              }
            </div>
            <div>
              <strong>Rencana Program:</strong><br>${
                formData.get("rencanaProgram") || "-"
              }
            </div>

            <!-- Data Orang Tua -->
            <div class="col-span-full mt-3">
              <h6 class="bg-brand-600 text-white p-2 rounded">
                <i class="bi bi-people"></i> Data Orang Tua
              </h6>
            </div>
            <div>
              <strong>Nama Ayah:</strong><br>${formData.get("namaAyah") || "-"}
            </div>
            <div>
              <strong>NIK Ayah:</strong><br>${formData.get("nikAyah") || "-"}
            </div>
            <div>
              <strong>Status Ayah:</strong><br>${
                formData.get("statusAyah") || "-"
              }
            </div>
            <div>
              <strong>Pekerjaan Ayah:</strong><br>${
                formData.get("pekerjaanAyah") || "-"
              }
            </div>
            <div>
              <strong>Nama Ibu:</strong><br>${formData.get("namaIbu") || "-"}
            </div>
            <div>
              <strong>NIK Ibu:</strong><br>${formData.get("nikIbu") || "-"}
            </div>
            <div>
              <strong>Status Ibu:</strong><br>${
                formData.get("statusIbu") || "-"
              }
            </div>
            <div>
              <strong>Pekerjaan Ibu:</strong><br>${
                formData.get("pekerjaanIbu") || "-"
              }
            </div>
            <div>
              <strong>No Telepon Orang Tua:</strong><br>${
                formData.get("teleponOrtu") || "-"
              }
            </div>

            <!-- Berkas Upload -->
            <div class="col-span-full mt-3">
              <h6 class="bg-brand-600 text-white p-2 rounded">
                <i class="bi bi-file-earmark-arrow-up"></i> Berkas yang Akan Diupload
              </h6>
            </div>
        `;

        const files = [
          { key: "fileIjazah", label: "Scan Ijazah" },
          { key: "fileAkta", label: "Scan Akta" },
          { key: "fileFoto", label: "Pas Foto" },
          { key: "fileBPJS", label: "Kartu BPJS (Opsional)" },
        ];

        let hasFiles = false;
        files.forEach((file) => {
          const uploadedFile = formData.get(file.key);
          if (uploadedFile && uploadedFile.size > 0) {
            hasFiles = true;
            html += `
              <div>
                <div class="bg-green-100 text-green-800 p-3 rounded-lg flex items-center">
                  <i class="bi bi-check-circle mr-2"></i> ${file.label}: <strong>${
              uploadedFile.name
            }</strong> (${(uploadedFile.size / 1024).toFixed(2)} KB)
                </div>
              </div>
            `;
          }
        });

        if (!hasFiles) {
          html += `
            <div class="col-span-full">
              <div class="bg-blue-100 text-blue-800 p-3 rounded-lg flex items-center">
                <i class="bi bi-info-circle mr-2"></i> Tidak ada berkas yang diupload
              </div>
            </div>
          `;
        }

        html += `</div>`;

          document.getElementById("konfirmasiContent").innerHTML = html;
          console.log('[KONFIRMASI] HTML set, opening modal...');
          
          // PURE CSS CLASS APPROACH - NO ALPINE DEPENDENCY
          const modalEl = document.getElementById('modalKonfirmasi');
          
          if (modalEl) {
            // Remove hidden class, add visible class
            modalEl.classList.remove('modal-hidden');
            modalEl.classList.add('modal-visible');
            console.log('[KONFIRMASI] ✓✓ Modal shown via CSS class (PURE DOM)');
            
            // Also set Alpine store if available (for close button)
            if (window.Alpine && Alpine.store && Alpine.store('modals')) {
              Alpine.store('modals').showKonfirmasi = true;
              console.log('[KONFIRMASI] ✓ Alpine store also set');
            }
          } else {
            console.error('[KONFIRMASI] ❌ Modal element #modalKonfirmasi not found!');
            alert('Error: Modal tidak ditemukan!');
          }
        } catch (error) {
          console.error('[KONFIRMASI] Error:', error);
          toastr.error('Terjadi kesalahan: ' + error.message);
        }
      }

      // Function to convert file to base64
      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => {
            const base64 = reader.result.split(",")[1];
            resolve(base64);
          };
          reader.onerror = (error) => reject(error);
        });
      }

      // FIXED: Client-side image compression with proper async/await
      async function compressClientSide(file, targetBytes = 1 * 1024 * 1024) {
        console.log('[COMPRESS_START]', file.name, '→', (file.size / 1024 / 1024).toFixed(2), 'MB');
        
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          
          reader.onload = async (event) => {
            try {
              const img = new Image();
              
              // Wrap image loading in Promise
              await new Promise((resolveImg, rejectImg) => {
                img.onload = () => resolveImg(true);
                img.onerror = () => rejectImg(new Error('Failed to load image'));
                img.src = event.target.result;
              });

              // Image loaded successfully, now process
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');

              let width = img.width;
              let height = img.height;
              const maxDim = 1600;

              console.log('[COMPRESS] Original:', width, 'x', height);

              // Resize if needed
              if (width > height) {
                if (width > maxDim) {
                  height *= maxDim / width;
                  width = maxDim;
                }
              } else {
                if (height > maxDim) {
                  width *= maxDim / height;
                  height = maxDim;
                }
              }

              canvas.width = width;
              canvas.height = height;

              // Fill white background for PNG
              if (file.type === 'image/png') {
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, width, height);
              }

              ctx.drawImage(img, 0, 0, width, height);

              const originalExt = file.name.split('.').pop().toLowerCase();
              let finalMimeType = file.type;

              // Helper: Promisify canvas.toBlob
              const toBlobPromise = (mimeType, quality) => {
                return new Promise((res) => {
                  canvas.toBlob((blob) => res(blob), mimeType, quality);
                });
              };

              let outputBlob = null;

              // JPEG compression
              if (file.type === 'image/jpeg' || file.type === 'image/jpg') {
                finalMimeType = 'image/jpeg';
                let quality = 0.9;
                
                console.log('[COMPRESS] JPEG compression loop...');
                
                // Try decreasing quality
                while (quality >= 0.3) {
                  outputBlob = await toBlobPromise(finalMimeType, quality);
                  
                  const sizeMB = (outputBlob.size / 1024 / 1024).toFixed(2);
                  console.log('[COMPRESS] Q=' + quality.toFixed(1), '→', sizeMB, 'MB');
                  
                  if (outputBlob.size <= targetBytes) {
                    console.log('[COMPRESS] ✓ Target reached!');
                    break;
                  }
                  quality -= 0.1;
                }
                
                // Final fallback
                if (!outputBlob || outputBlob.size > targetBytes) {
                  console.warn('[COMPRESS] Using minimum quality');
                  outputBlob = await toBlobPromise(finalMimeType, 0.3);
                }
              } 
              // PNG compression
              else if (file.type === 'image/png') {
                console.log('[COMPRESS] PNG processing...');
                finalMimeType = 'image/png';
                outputBlob = await toBlobPromise(finalMimeType, 1.0);
                
                // Convert to JPEG if PNG is too large
                if (outputBlob.size > targetBytes) {
                  console.log('[COMPRESS] PNG → JPEG conversion...');
                  finalMimeType = 'image/jpeg';
                  outputBlob = await toBlobPromise(finalMimeType, 0.8);
                }
              } 
              // Not an image
              else {
                console.log('[COMPRESS] Not a compressible type, using original');
                outputBlob = file;
                finalMimeType = file.type;
              }

              if (!outputBlob) {
                throw new Error('Failed to create compressed blob');
              }

              const finalSizeKB = (outputBlob.size / 1024).toFixed(2);
              const reduction = (((file.size - outputBlob.size) / file.size) * 100).toFixed(1);
              
              console.log('[COMPRESS_END] Final:', finalSizeKB, 'KB (−' + reduction + '%)');

              resolve({
                blob: outputBlob,
                ext: finalMimeType === 'image/jpeg' ? 'jpg' : originalExt,
                mime: finalMimeType,
                alreadyCompressed: true,
              });
              
            } catch (error) {
              console.error('[COMPRESS_ERROR]', error);
              reject(error);
            }
          };
          
          reader.onerror = (error) => {
            console.error('[COMPRESS_ERROR] FileReader:', error);
            reject(error);
          };
          
          reader.readAsDataURL(file);
        });
      }

      // Function to copy NISN to clipboard
      function salinNISN() {
        const regNo = document.getElementById("regNo").textContent;
        const btnSalin = document.getElementById("btnSalinReg");

        navigator.clipboard
          .writeText(regNo)
          .then(() => {
            const originalHTML = btnSalin.innerHTML;
            btnSalin.innerHTML =
              '<i class="bi bi-check-circle-fill"></i> Tersalin!';
            btnSalin.classList.remove("btn-outline-primary");
            btnSalin.classList.add("btn-success");

            setTimeout(() => {
              btnSalin.innerHTML = originalHTML;
              btnSalin.classList.remove("btn-success");
              btnSalin.classList.add("btn-outline-primary");
            }, 2000);
          })
          .catch((err) => {
            toastr.error("Gagal menyalin: " + err);
          });
      }

      // Function to upload file via backend API with timeout
      async function uploadFile(file, type, nisn) {
        if (!file) {
          console.log(`[UPLOAD] No file provided for ${type}, skipping`);
          return null;
        }

        // Validate file object
        if (!(file instanceof Blob) && !(file instanceof File)) {
          console.error(`[UPLOAD] Invalid file object for ${type}:`, file);
          throw new Error(`File ${type} tidak valid`);
        }

        // Validate file size
        if (!file.size || file.size === 0) {
          console.error(`[UPLOAD] File ${type} is empty (0 bytes)`);
          throw new Error(`File ${type} kosong atau corrupt`);
        }

        if (!nisn || nisn.length !== 10 || !/^[0-9]{10}$/.test(nisn)) {
          throw new Error(`NISN tidak valid: ${nisn}. Harus 10 digit angka.`);
        }
        
        console.log(`[UPLOAD] Validating ${type}: ${file.name || 'unnamed'} (${(file.size / 1024).toFixed(2)} KB)`);

        let processedFile = file;
        let fileExtension = file.name.split('.').pop().toLowerCase();
        let finalMimeType = file.type;
        let alreadyCompressed = false;

        const imageMimes = ['image/jpeg', 'image/png', 'image/jpg', 'image/gif', 'image/webp'];
        const isImage = imageMimes.includes(file.type.toLowerCase());
        
        if (isImage) {
          console.log(`[COMPRESS] Mengkompresi gambar ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)...`);
          try {
            const compressedResult = await compressClientSide(file);
            
            if (!compressedResult || !compressedResult.blob) {
              throw new Error('Compression returned invalid result');
            }
            
            processedFile = compressedResult.blob;
            fileExtension = compressedResult.ext;
            finalMimeType = compressedResult.mime;
            alreadyCompressed = compressedResult.alreadyCompressed;
            
            console.log(`[COMPRESS] ✓ Gambar ${file.name} selesai dikompresi. Ukuran: ${(processedFile.size / 1024).toFixed(2)} KB`);
          } catch (compressError) {
            console.error(`[COMPRESS] ❌ Gagal kompresi untuk ${file.name}:`, compressError);
            console.warn(`[COMPRESS] ⚠️ Menggunakan file asli tanpa kompresi.`);
            processedFile = file;
            alreadyCompressed = false;
          }
        } else {
          console.log(`[COMPRESS] File ${file.name} bukan gambar, tidak dikompresi.`);
        }

        const MAX_CLIENT_SIZE_BYTES = 2 * 1024 * 1024; // 2MB
        if (processedFile.size > MAX_CLIENT_SIZE_BYTES) {
          throw new Error(`File ${type} terlalu besar (${(processedFile.size / 1024 / 1024).toFixed(2)} MB). Maksimal 2 MB.`);
        }

        console.log(`[UPLOAD] Uploading ${type}: ${file.name} (${(processedFile.size / 1024).toFixed(2)} KB)`);

        try {
          // Convert to base64
          console.log(`[UPLOAD] Converting ${type} to base64...`);
          const base64Data = await fileToBase64(processedFile);
          
          if (!base64Data || base64Data.length === 0) {
            throw new Error('Failed to convert file to base64');
          }
          
          console.log(`[UPLOAD] Base64 length: ${base64Data.length} chars`);
          
          const finalFileName = `${nisn}_${type}.${fileExtension}`;
          console.log(`[UPLOAD] Final filename: ${finalFileName}`);

          // Create AbortController for timeout
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 60000); // 60s timeout

          const response = await fetch("/api/upload_file", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              file: base64Data,
              fileName: finalFileName,
              fileType: type,
              mimeType: finalMimeType,
              nisn: nisn,
              alreadyCompressed: alreadyCompressed
            }),
            signal: controller.signal
          });

          clearTimeout(timeout);

          const result = await response.json();
          console.log(`[UPLOAD] ✓ ${type} result:`, result);

          if (!response.ok) {
            throw new Error(result.error || `Upload ${type} gagal (HTTP ${response.status})`);
          }
          if (!result.ok) {
            throw new Error(result.error || `Upload ${type} gagal`);
          }

          return result.url;
        } catch (error) {
          if (error.name === 'AbortError') {
            throw new Error(`Upload ${type} timeout (> 60s). File mungkin terlalu besar atau koneksi lambat.`);
          }
          throw error;
        }
      }

      // Function to submit final
      async function submitFinal() {
        const submitBtn = document.querySelector('#btnKonfirmasiKirim');
        const originalText = submitBtn.innerHTML;

        submitBtn.disabled = true;
        submitBtn.innerHTML =
          '<span class="inline-block animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></span>Mengirim...';

        try {
          const formData = formDataGlobal;
          const data = {};

          for (let [key, value] of formData.entries()) {
            if (!key.startsWith("file")) {
              data[key] = value;
            }
          }

          console.log("[SUBMIT] Data yang akan dikirim:", data);
          console.log("[SUBMIT] Total fields:", Object.keys(data).length);

          submitBtn.innerHTML =
            '<span class="inline-block animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></span>Menyimpan data...';

          console.log("[SUBMIT] Sending POST to /api/pendaftar_create...");
          const res = await fetch("/api/pendaftar_create", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          console.log("[SUBMIT] Response status:", res.status);
          console.log("[SUBMIT] Response headers:", Object.fromEntries(res.headers.entries()));
          
          const responseText = await res.text();
          console.log("[SUBMIT] Raw response text:", responseText);
          
          let json;
          try {
            json = JSON.parse(responseText);
          } catch (parseError) {
            console.error("[SUBMIT] ❌ Failed to parse JSON:", parseError);
            console.error("[SUBMIT] Response was:", responseText);
            throw new Error(`Server response tidak valid (bukan JSON): ${responseText.substring(0, 100)}`);
          }
          
          console.log("[SUBMIT] Parsed response:", json);
          console.log("[SUBMIT] json.ok =", json.ok);
          console.log("[SUBMIT] json.nisn =", json.nisn);
          console.log("[SUBMIT] json.id =", json.id);

          if (!json.ok) {
            console.error("[SUBMIT] ❌ Server returned ok=false");
            console.error("[SUBMIT] Error:", json.error);
            console.error("[SUBMIT] Details:", json.details);
            throw new Error(json.error || "Gagal menyimpan data");
          }
          
          console.log("[SUBMIT] ✓ Data berhasil disimpan!");

          const nisn = json.nisn;
          const pendaftarId = json.id;

          console.log("[SUBMIT] Extracted NISN:", nisn, "Type:", typeof nisn);
          console.log("[SUBMIT] Extracted ID:", pendaftarId, "Type:", typeof pendaftarId);

          if (!nisn) {
            console.error("[SUBMIT] ❌ NISN is null/undefined/empty!");
            console.error("[SUBMIT] Full response object:", JSON.stringify(json, null, 2));
            throw new Error("NISN tidak diterima dari server. Response: " + JSON.stringify(json));
          }

          console.log("NISN:", nisn);
          console.log("Pendaftar ID:", pendaftarId);

          const fileIjazah = formData.get("fileIjazah");
          const fileAkta = formData.get("fileAkta");
          const fileFoto = formData.get("fileFoto");
          const fileBPJS = formData.get("fileBPJS");

          const fileUrls = {};

          console.log("[UPLOAD] Mulai upload files...");
          
          if (fileIjazah?.size > 0) {
            console.log("[UPLOAD] Processing Ijazah...");
            submitBtn.innerHTML =
              '<span class="inline-block animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></span>Upload ijazah...';
            try {
              fileUrls.file_ijazah = await uploadFile(fileIjazah, "ijazah", nisn);
              console.log("[UPLOAD] ✓ Ijazah berhasil");
            } catch (uploadError) {
              console.error("[UPLOAD] ❌ Ijazah gagal:", uploadError);
              throw new Error(`Upload Ijazah gagal: ${uploadError.message}`);
            }
          }

          if (fileAkta?.size > 0) {
            console.log("[UPLOAD] Processing Akta...");
            submitBtn.innerHTML =
              '<span class="inline-block animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></span>Upload akta...';
            try {
              fileUrls.file_akta = await uploadFile(fileAkta, "akta", nisn);
              console.log("[UPLOAD] ✓ Akta berhasil");
            } catch (uploadError) {
              console.error("[UPLOAD] ❌ Akta gagal:", uploadError);
              throw new Error(`Upload Akta gagal: ${uploadError.message}`);
            }
          }

          if (fileFoto?.size > 0) {
            console.log("[UPLOAD] Processing Foto...");
            submitBtn.innerHTML =
              '<span class="inline-block animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></span>Upload foto...';
            try {
              fileUrls.file_foto = await uploadFile(fileFoto, "foto", nisn);
              console.log("[UPLOAD] ✓ Foto berhasil");
            } catch (uploadError) {
              console.error("[UPLOAD] ❌ Foto gagal:", uploadError);
              throw new Error(`Upload Foto gagal: ${uploadError.message}`);
            }
          }

          if (fileBPJS?.size > 0) {
            console.log("[UPLOAD] Processing BPJS...");
            submitBtn.innerHTML =
              '<span class="inline-block animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></span>Upload BPJS...';
            try {
              fileUrls.file_bpjs = await uploadFile(fileBPJS, "bpjs", nisn);
              console.log("[UPLOAD] ✓ BPJS berhasil");
            } catch (uploadError) {
              console.error("[UPLOAD] ❌ BPJS gagal:", uploadError);
              throw new Error(`Upload BPJS gagal: ${uploadError.message}`);
            }
          }
          
          console.log("[UPLOAD] ✓ Semua file selesai diupload!");

          if (Object.keys(fileUrls).length > 0) {
            submitBtn.innerHTML =
              '<span class="inline-block animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></span>Finalisasi...';

            const updateRes = await fetch("/api/pendaftar_update_files", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                id: pendaftarId,
                ...fileUrls,
              }),
            });

            const updateJson = await updateRes.json();
            if (!updateJson.ok) {
              console.warn("Warning: File URLs not saved", updateJson.error);
            }
          }

          // Hide konfirmasi modal (PURE CSS)
          const modalKonfirmasi = document.getElementById('modalKonfirmasi');
          if (modalKonfirmasi) {
            modalKonfirmasi.classList.remove('modal-visible');
            modalKonfirmasi.classList.add('modal-hidden');
          }

          // Set NISN dan show success modal
          document.getElementById("regNo").textContent = nisn;

          // Reset form
          form.reset();
          form.classList.remove("was-validated");

          // Show success modal (PURE CSS)
          const modalSukses = document.getElementById('modalSukses');
          if (modalSukses) {
            modalSukses.classList.remove('modal-hidden');
            modalSukses.classList.add('modal-visible');
          }
        } catch (error) {
          console.error("=".repeat(80));
          console.error("❌ SUBMIT ERROR DETAILS:");
          console.error("=".repeat(80));
          console.error("Error Type:", error.constructor.name);
          console.error("Error Message:", error.message);
          console.error("Error Stack:", error.stack);
          console.error("=".repeat(80));

          let errorMsg = error.message || "Terjadi kesalahan";
          if (
            errorMsg.includes("NISN tidak valid") ||
            errorMsg.includes("undefined")
          ) {
            errorMsg =
              "Gagal mendapatkan NISN dari server. Pastikan NISN sudah diisi dengan benar.";
          } else if (errorMsg.includes("timeout")) {
            errorMsg = "Request timeout. Silakan cek koneksi internet Anda dan coba lagi.";
          } else if (errorMsg.includes("NetworkError") || errorMsg.includes("Failed to fetch")) {
            errorMsg = "Koneksi gagal. Pastikan internet Anda stabil dan server dapat diakses.";
          }
          
          toastr.error(`❌ Error: ${errorMsg}`, "Pendaftaran Gagal", {
            timeOut: 10000,
            closeButton: true,
            progressBar: true
          });
          
          // Alert for critical errors
          if (errorMsg.includes("Upload") || errorMsg.includes("kompresi")) {
            alert(`⚠️ DETAIL ERROR:\n\n${errorMsg}\n\nSilakan:\n1. Pastikan file tidak terlalu besar (max 2MB)\n2. Cek format file (JPEG/PNG/PDF)\n3. Cek koneksi internet\n4. Coba lagi`);
          }
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      }

      form.addEventListener("submit", (e) => {
        e.preventDefault();
      });

      // Load data from localStorage if editing
      window.addEventListener("load", () => {
        if (window.location.hash === "#edit") {
          const editData = localStorage.getItem("editPendaftaran");
          if (editData) {
            try {
              const data = JSON.parse(editData);
              console.log("Loading edit data:", data);

              if (data.nik)
                document.querySelector('[name="nikCalon"]').value = data.nik;
              if (data.nisn)
                document.querySelector('[name="nisn"]').value = data.nisn;
              if (data.nama)
                document.querySelector('[name="namaLengkap"]').value =
                  data.nama;

              if (data.provinsiTempatLahir) {
                const provinsiSelect = document.querySelector(
                  '[name="provinsiTempatLahir"]');
                provinsiSelect.value = data.provinsiTempatLahir;
                provinsiSelect.dispatchEvent(new Event("change"));
                setTimeout(() => {
                  if (data.tempatLahir) {
                    document.querySelector('[name="tempatLahir"]').value =
                      data.tempatLahir;
                  }
                }, 100);
              }

              if (data.tanggalLahir)
                document.querySelector('[name="tanggalLahir"]').value =
                  data.tanggalLahir;
              if (data.jenisKelamin)
                document.querySelector('[name="jenisKelamin"]').value =
                  data.jenisKelamin;
              if (data.teleponOrtu)
                document.querySelector('[name="teleponOrtu"]').value =
                  data.teleponOrtu;

              if (data.alamatJalan)
                document.querySelector('[name="alamatJalan"]').value =
                  data.alamatJalan;

              if (data.provinsi) {
                const provinsiSelect =
                  document.querySelector('[name="provinsi"]');
                provinsiSelect.value = data.provinsi;
                provinsiSelect.dispatchEvent(new Event("change"));

                setTimeout(() => {
                  if (data.kotaKabupaten) {
                    const kotaSelect = document.querySelector(
                      '[name="kotaKabupaten"]');
                    kotaSelect.value = data.kotaKabupaten;
                    kotaSelect.dispatchEvent(new Event("change"));

                    setTimeout(() => {
                      if (data.kecamatan) {
                        const kecamatanSelect =
                          document.querySelector('[name="kecamatan"]');
                        kecamatanSelect.value = data.kecamatan;
                        kecamatanSelect.dispatchEvent(new Event("change"));

                        setTimeout(() => {
                          if (data.desa) {
                            document.querySelector('[name="desa"]').value =
                              data.desa;
                          }
                        }, 100);
                      }
                    }, 100);
                  }
                }, 100);
              }

              if (data.ijazahFormalTerakhir)
                document.querySelector('[name="ijazahFormalTerakhir"]').value =
                  data.ijazahFormalTerakhir;
              if (data.rencanaProgram)
                document.querySelector('[name="rencanaProgram"]').value =
                  data.rencanaProgram;
              if (data.rencanaDomisili)
                document.querySelector('[name="rencanaDomisili"]').value =
                  data.rencanaDomisili;
              if (data.rencanaTingkat)
                document.querySelector('[name="rencanaTingkat"]').value =
                  data.rencanaTingkat;

              if (data.nikAyah)
                document.querySelector('[name="nikAyah"]').value = data.nikAyah;
              if (data.namaAyah)
                document.querySelector('[name="namaAyah"]').value =
                  data.namaAyah;
              if (data.nikIbu)
                document.querySelector('[name="nikIbu"]').value = data.nikIbu;
              if (data.namaIbu)
                document.querySelector('[name="namaIbu"]').value = data.namaIbu;

              localStorage.removeItem("editPendaftaran");

              toastr.info("Mode Perbaikan: Data pendaftaran Anda yang sebelumnya telah dimuat. Silakan perbaiki data yang diperlukan dan submit ulang.");

              window.scrollTo({ top: 0, behavior: "smooth" });
            } catch (error) {
              console.error("Error loading edit data:", error);
              localStorage.removeItem("editPendaftaran");
            }
          }
        }
      });
    </script>
  </body>
</html>
