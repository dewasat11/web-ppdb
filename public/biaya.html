<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Rincian biaya pendaftaran dan pendidikan PPDSB Pondok Pesantren Al Ikhsan Beji. Transparansi biaya untuk calon santri dan wali.">
  <meta name="keywords" content="Biaya Pondok Pesantren Al Ikhsan Beji, biaya pendaftaran, biaya tahfidz, biaya MTs MA PPDSB">
  <title>Biaya Pendaftaran - PPDSB Pondok Pesantren Al Ikhsan Beji</title>

  <link rel="icon" href="/favicon.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/a2e0d1f7f4.js" crossorigin="anonymous"></script>
  <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet">

</head>
<body class="min-h-screen flex flex-col bg-white text-gray-800">
  <!-- HEADER -->
  <header class="bg-brand-700 text-white shadow-lg py-4">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
      <div class="flex-shrink-0">
        <a href="/" class="text-white font-bold text-xl">PPDSB Al Ikhsan Beji</a>
      </div>
      <nav class="hidden md:block">
        <div class="flex items-baseline space-x-4">
          <a href="/" class="text-white hover:text-brand-100 px-3 py-2 rounded-md text-sm font-medium">Beranda</a>
          <a href="/alur-pendaftaran.html" class="text-white hover:text-brand-100 px-3 py-2 rounded-md text-sm font-medium">Alur Pendaftaran</a>
          <a href="/syarat-pendaftaran.html" class="text-white hover:text-brand-100 px-3 py-2 rounded-md text-sm font-medium">Syarat Pendaftaran</a>
          <a href="/biaya.html" class="text-brand-100 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Biaya</a>
          <a href="/brosur.html" class="text-white hover:text-brand-100 px-3 py-2 rounded-md text-sm font-medium">Brosur</a>
          <a href="/kontak.html" class="text-white hover:text-brand-100 px-3 py-2 rounded-md text-sm font-medium">Kontak</a>
        </div>
      </nav>
    </div>
  </header>

  <!-- MAIN -->
  <main class="flex-1 container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Biaya Pendaftaran</h1>
    <div class="prose max-w-none">
      <p>Berikut adalah rincian biaya pendaftaran dan pendidikan di Pondok Pesantren Al Ikhsan Beji:</p>
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Biaya</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">Biaya Pendaftaran</td>
            <td class="px-6 py-4 whitespace-nowrap">Rp 300.000,-</td>
          </tr>
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">Uang Pangkal (Sarana & Prasarana)</td>
            <td class="px-6 py-4 whitespace-nowrap">Rp 3.000.000,-</td>
          </tr>
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">Uang DSP (Dana Sumbangan Pendidikan)</td>
            <td class="px-6 py-4 whitespace-nowrap">Rp 2.500.000,-</td>
          </tr>
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">Uang Buku & Seragam (per tahun)</td>
            <td class="px-6 py-4 whitespace-nowrap">Rp 1.500.000,-</td>
          </tr>
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">SPP Bulanan</td>
            <td class="px-6 py-4 whitespace-nowrap">Rp 750.000,-</td>
          </tr>
        </tbody>
      </table>
      <p class="mt-4">Catatan: Biaya dapat berubah sewaktu-waktu. Untuk informasi lebih lanjut, silakan hubungi bagian administrasi.</p>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="bg-brand-700 text-white py-6 shadow-inner mt-auto">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <p class="text-sm">&copy; 2025 Pondok Pesantren Al Ikhsan Beji. All rights reserved. <span class="hidden sm:inline">Development by Tim IT Pesantren</span></p>
    </div>
  </footer>

  <!-- Vendors JS (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script>
    // Shim toastr -> toastify agar kompatibel dgn snippet lama
    window.toastr = {
      success(msg){ Toastify({ text: msg, duration: 4000, close: true, gravity: 'top', position: 'right', style: { background: '#10b981', color: '#fff' }}).showToast(); },
      error(msg){ Toastify({ text: msg, duration: 4000, close: true, gravity: 'top', position: 'right', style: { background: '#ef4444', color: '#fff' }}).showToast(); },
      warning(msg){ Toastify({ text: msg, duration: 4000, close: true, gravity: 'top', position: 'right', style: { background: '#f59e0b', color: '#fff' }}).showToast(); },
      info(msg){ Toastify({ text: msg, duration: 4000, close: true, gravity: 'top', position: 'right', style: { background: '#3b82f6', color: '#fff' }}).showToast(); }
    }
  </script>

  <!-- Gelombang Data Loader (Business Logic: Active-based Status) -->
  <script>
    /* ===== UI MAPPING ===== */
    const UI = {
      label: {
        ACTIVE: "Pendaftaran Dibuka",
        UPCOMING: "Segera Dibuka",
        CLOSED: "Ditutup",
        NOT_ACTIVE: "Belum Aktif",
      },
      color: {
        ACTIVE: "green",
        UPCOMING: "blue",
        CLOSED: "gray",
        NOT_ACTIVE: "gray",
      }
    };

    /**
     * Decorate gelombang dengan status berdasarkan activeId
     * KONDISI BISNIS:
     * - Jika Gelombang 1 AKTIF → Gelombang 2 & 3 = "Segera Dibuka"
     * - Jika Gelombang 2 AKTIF → Gelombang 1 = "Ditutup", Gelombang 3 = "Segera Dibuka"
     * - Jika Gelombang 3 AKTIF → Gelombang 1 & 2 = "Ditutup"
     * - TIDAK pakai logika tanggal untuk label
     */
    function decorateGelombang(waves, activeId) {
      const byId = Object.fromEntries(waves.map(w => [w.id, w]));

      function setState(id, stateKey) {
        const w = byId[id]; 
        if (!w) return;
        w._state = stateKey;
        w._label = UI.label[stateKey];
        w._color = UI.color[stateKey];
      }

      // Default semua "NOT_ACTIVE"
      waves.forEach(w => setState(w.id, "NOT_ACTIVE"));

      // Aturan bisnis
      if (activeId === 1) {
        setState(1, "ACTIVE");
        setState(2, "UPCOMING");
        setState(3, "UPCOMING");
      } else if (activeId === 2) {
        setState(2, "ACTIVE");
        setState(1, "CLOSED");
        setState(3, "UPCOMING");
      } else if (activeId === 3) {
        setState(3, "ACTIVE");
        setState(1, "CLOSED");
        setState(2, "CLOSED");
      }

      return waves;
    }
    
    /**
     * Fetch and render ALL 3 gelombang dengan status berdasarkan active gelombang
     */
    async function loadGelombangAktif() {
      try {
        const container = document.getElementById('gelombangContainer');
        
        // 1) Fetch all gelombang (3 waves)
        const cacheBuster = new Date().getTime();
        const listResponse = await fetch(`/api/get_gelombang_list?_t=${cacheBuster}`);
        const listResult = await listResponse.json();
        
        console.log('[GELOMBANG_LIST] API Response:', listResult);
        
        if (!listResult.ok || !listResult.data || listResult.data.length === 0) {
          console.log('[GELOMBANG_LIST] No gelombang data found');
          container.innerHTML = `
            <div class="text-center py-12 col-span-full">
              <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="bi bi-calendar-x text-gray-400 text-3xl"></i>
              </div>
              <h3 class="text-xl font-semibold text-gray-700 mb-2">Belum Ada Data Gelombang</h3>
              <p class="text-gray-500">Silakan tunggu informasi lebih lanjut.</p>
            </div>
          `;
          return;
        }
        
        // 2) Fetch active gelombang ID
        let activeId = null;
        try {
          const activeResponse = await fetch(`/api/gelombang_active?_t=${cacheBuster}`);
          const activeResult = await activeResponse.json();
          if (activeResult.ok && activeResult.data && typeof activeResult.data.id === "number") {
            activeId = activeResult.data.id;
            console.log('[GELOMBANG_ACTIVE] Active ID:', activeId);
          }
        } catch (e) {
          console.warn('[GELOMBANG_ACTIVE] Failed to fetch active gelombang:', e);
        }
        
        // 3) Decorate gelombang with business logic
        const gelombangList = decorateGelombang(listResult.data, activeId);
        
        console.log('[GELOMBANG_LIST] Rendering', gelombangList.length, 'gelombang with activeId:', activeId);
        
        // Map colors to CSS classes
        const colorMap = {
          green: {
            border: 'border-green-200',
            badge: 'bg-green-500',
            icon: 'bg-gradient-to-br from-green-500 to-green-600',
            iconText: 'text-green-500'
          },
          blue: {
            border: 'border-blue-200',
            badge: 'bg-blue-500',
            icon: 'bg-gradient-to-br from-blue-500 to-blue-600',
            iconText: 'text-blue-500'
          },
          gray: {
            border: 'border-gray-200',
            badge: 'bg-gray-500',
            icon: 'bg-gradient-to-br from-gray-500 to-gray-600',
            iconText: 'text-gray-500'
          }
        };
        
        // 4) Generate HTML for all gelombang cards
        let cardsHTML = '';
        
        gelombangList.forEach(gelombang => {
          const colors = colorMap[gelombang._color] || colorMap.gray;
          
          console.log('[GELOMBANG_LIST] Rendering:', gelombang.nama, '| state:', gelombang._state, '| label:', gelombang._label);
          
          // Determine button state based on _state
          let buttonHTML = '';
          let statusHTML = '';
          
          if (gelombang._state === 'ACTIVE') {
            buttonHTML = `<a href="/daftar.html" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg inline-block text-center transition shadow-md hover:shadow-lg">
              <i class="bi bi-pencil-square mr-2"></i>Daftar Sekarang
            </a>`;
            statusHTML = `<div class="bg-green-50 rounded-lg p-3 mb-4"><p class="text-sm text-green-700 font-medium">✓ Pendaftaran Dibuka</p></div>`;
          } else if (gelombang._state === 'UPCOMING') {
            buttonHTML = `<button class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg cursor-default" disabled>
              <i class="bi bi-clock mr-2"></i>Segera Dibuka
            </button>`;
            statusHTML = `<div class="bg-blue-50 rounded-lg p-3 mb-4"><p class="text-sm text-blue-700 font-medium">📅 Segera Dibuka</p></div>`;
          } else if (gelombang._state === 'CLOSED') {
            buttonHTML = `<button class="w-full bg-gray-300 text-gray-600 cursor-not-allowed font-semibold py-3 px-6 rounded-lg" disabled>
              <i class="bi bi-x-circle mr-2"></i>Ditutup
            </button>`;
            statusHTML = `<div class="bg-gray-50 rounded-lg p-3 mb-4"><p class="text-sm text-gray-500 font-medium">⏱ Pendaftaran Ditutup</p></div>`;
          } else { // NOT_ACTIVE
            buttonHTML = `<button class="w-full bg-gray-300 text-gray-600 cursor-not-allowed font-semibold py-3 px-6 rounded-lg" disabled>
              <i class="bi bi-info-circle mr-2"></i>Belum Aktif
            </button>`;
            statusHTML = `<div class="bg-gray-50 rounded-lg p-3 mb-4"><p class="text-sm text-gray-500 font-medium">ℹ️ Belum Aktif</p></div>`;
          }
          
          // Format dates
          const startFormatted = formatDate(gelombang.start_date);
          const endFormatted = formatDate(gelombang.end_date);
          
          // Build card HTML
          cardsHTML += `
            <div class="bg-white rounded-2xl p-6 shadow-xl border-2 ${colors.border} relative overflow-hidden hover:shadow-2xl transition">
              <div class="absolute top-0 right-0 ${colors.badge} text-white px-4 py-2 rounded-bl-lg text-sm font-semibold">${gelombang._label}</div>
              <div class="text-center mt-4">
                <div class="w-16 h-16 ${colors.icon} rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                  <i class="bi bi-calendar-check text-white text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold mb-2 text-gray-800">${gelombang.nama}</h3>
                <div class="space-y-2 mb-4">
                  <div class="flex items-center justify-center text-gray-600">
                    <i class="bi bi-calendar-event mr-2 ${colors.iconText}"></i>
                    <span class="text-sm">${startFormatted} - ${endFormatted}</span>
                  </div>
                  <div class="flex items-center justify-center text-gray-600">
                    <i class="bi bi-mortarboard mr-2 ${colors.iconText}"></i>
                    <span class="text-sm font-semibold">Tahun Ajaran ${gelombang.tahun_ajaran}</span>
                  </div>
                </div>
                ${statusHTML}
                ${buttonHTML}
              </div>
            </div>
          `;
        });
        
        // Render all cards in grid
        container.innerHTML = cardsHTML;
        
      } catch (error) {
        console.error('[GELOMBANG_LIST] Error:', error);
        document.getElementById('gelombangContainer').innerHTML = `
          <div class="text-center py-12 col-span-full">
            <i class="bi bi-exclamation-triangle text-red-500 text-4xl mb-3"></i>
            <p class="text-gray-600">Gagal memuat data gelombang. Silakan refresh halaman.</p>
          </div>
        `;
      }
    }

    function formatDate(dateString) {
      const options = { day: 'numeric', month: 'long', year: 'numeric' };
      const date = new Date(dateString);
      return date.toLocaleDateString('id-ID', options);
    }

    // Load active gelombang when page loads
    document.addEventListener('DOMContentLoaded', loadGelombangAktif);
    
    // ===== REAL-TIME SYNC WITH ADMIN =====
    
    // Method 1: Listen for changes from admin panel via localStorage (cross-tab)
    window.addEventListener('storage', function(e) {
      if (e.key === 'gelombang_update') {
        try {
          const update = JSON.parse(e.newValue);
          console.log('[GELOMBANG] 📡 Received update from admin (storage event):', update);
          console.log('[GELOMBANG] 🔄 Reloading gelombang display...');
          
          // Show toast notification to user
          if (typeof toastr !== 'undefined' && toastr.info) {
            toastr.info('Data gelombang diperbarui!');
          }
          
          // Reload with slight delay to ensure DB is updated
          setTimeout(() => {
            loadGelombangAktif();
          }, 500);
        } catch (err) {
          console.log('[GELOMBANG] Admin updated gelombang (legacy format), reloading...');
          setTimeout(() => {
            loadGelombangAktif();
          }, 500);
        }
      }
    });
    
    // Method 2: Listen for custom event (same-window sync - if admin in iframe)
    window.addEventListener('gelombangUpdated', function(e) {
      console.log('[GELOMBANG] 📡 Received update (custom event):', e.detail);
      console.log('[GELOMBANG] 🔄 Reloading gelombang display...');
      
      setTimeout(() => {
        loadGelombangAktif();
      }, 500);
    });
    
    // Method 3: Periodic polling as fallback (every 60 seconds)
    setInterval(() => {
      console.log('[GELOMBANG] 🔄 Periodic refresh (fallback)...');
      loadGelombangAktif();
    }, 60000); // 60 seconds
  </script>
  
  <!-- Supabase Real-Time Sync (Optional - for cross-tab/cross-device sync) -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    
    // Initialize Supabase client (same credentials as admin)
    const SUPABASE_URL = 'https://sxbvadzcwpaovkhghttv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN4YnZhZHpjd3Bhb3ZraGdodHR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMDg4MDYsImV4cCI6MjA3NjY4NDgwNn0.miJeKmsNgjgS4fWegGlwrxF_cPUoZBT0YKl1oxmmXTE';
    
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    console.log('[SUPABASE INDEX] ✅ Client initialized for real-time sync');
    
    // Subscribe to gelombang table changes (real-time across devices)
    const channel = supabase
      .channel('gelombang-changes-public')
      .on('postgres_changes', { 
        event: '*', 
        schema: 'public', 
        table: 'gelombang' 
      }, (payload) => {
        console.log('[SUPABASE INDEX] 🔄 Gelombang data changed:', payload);
        console.log('[SUPABASE INDEX] Event type:', payload.eventType);
        
        // Show notification to user
        if (typeof toastr !== 'undefined' && toastr.info) {
          toastr.info('📊 Data gelombang diperbarui dari server');
        }
        
        // Reload immediately (database already consistent)
        setTimeout(() => {
          console.log('[SUPABASE INDEX] 🔄 Reloading gelombang display from Supabase event...');
          if (typeof loadGelombangAktif === 'function') {
            loadGelombangAktif();
          }
        }, 300);
      })
      .subscribe((status) => {
        if (status === 'SUBSCRIBED') {
          console.log('[SUPABASE INDEX] ✅ Subscribed to real-time gelombang updates');
          console.log('[SUPABASE INDEX] 🎧 Listening for database changes...');
        } else if (status === 'CLOSED') {
          console.log('[SUPABASE INDEX] ⚠️ Real-time connection closed');
        }
        console.log('[SUPABASE INDEX] Connection status:', status);
      });
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      console.log('[SUPABASE INDEX] 🔌 Unsubscribing from real-time updates');
      supabase.removeChannel(channel);
    });
  </script>
</body>
</html>
